(()=>{var e={956:e=>{e.exports='<svg fill="currentColor" class="bi bi-type-bold" viewBox="0 0 16 16" version="1.1" id="svg4" sodipodi:docname="a.svg" inkscape:version="1.2.2 (732a01da63, 2022-12-09)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"><defs id="defs8"></defs><sodipodi:namedview id="namedview6" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25" inkscape:showpageshadow="2" inkscape:pageopacity="0.0" inkscape:pagecheckerboard="0" inkscape:deskcolor="#d1d1d1" showgrid="false" inkscape:zoom="15.65625" inkscape:cx="-23.824351" inkscape:cy="6.0678643" inkscape:window-width="2560" inkscape:window-height="1369" inkscape:window-x="2552" inkscape:window-y="-8" inkscape:window-maximized="1" inkscape:current-layer="svg4"></sodipodi><text xml:space="preserve" style="font-size:210.095px;font-family:serif;-inkscape-font-specification:&#x27;serif, Normal&#x27;;text-align:center;text-anchor:middle;fill:#000000;stroke:#000000;stroke-width:0;stroke-opacity:0.992908" x="8.0039454" y="13.657977" id="text219"><tspan sodipodi:role="line" id="tspan217" x="8.0039454" y="13.657977" style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:16.1611px;font-family:&#x27;Segoe UI&#x27;;-inkscape-font-specification:&#x27;Segoe UI, Normal&#x27;;font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;stroke-width:0">A</tspan></text></svg>'},288:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-type-bold" viewBox="0 0 16 16"><path d="M8.21 13c2.106 0 3.412-1.087 3.412-2.823 0-1.306-.984-2.283-2.324-2.386v-.055a2.176 2.176 0 0 0 1.852-2.14c0-1.51-1.162-2.46-3.014-2.46H3.843V13zM5.908 4.674h1.696c.963 0 1.517.451 1.517 1.244 0 .834-.629 1.32-1.73 1.32H5.908V4.673zm0 6.788V8.598h1.73c1.217 0 1.88.492 1.88 1.415 0 .943-.643 1.449-1.832 1.449H5.907z"></path></svg>'},771:(e,t,n)=>{const i={};i.a=n(956),i.bold=n(288),e.exports=i},556:(e,t,n)=>{e.exports=class{MimirUI=n(176);MimirIcons=n(771);ascii=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~";invisible="&#xFEFF;";contentTags=["IMG","BR","HR"];stylingTags=["B","STRONG","I","EM","S","U","FONT","SUP","SUB","OL","UL","LI","H1","H2","H3","H4","H5","H6","BLOCKQUOTE"];inlineStylingTags=["B","STRONG","I","EM","S","U","FONT","SUP","SUB","A"];basicAllowedTags=["DIV","BR","P","IMG","LI","UL","OL","BLOCKQUOTE","HR"];blockTags=["BR","DIV","P","OL","UL","LI","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","HR"];childlessTags=["BR","IMG","HR"];inlineStylingCommands=["bold","italic","underline","strikethrough","font","size","foreColor","backColor","sup","sub","link"];blockStylingCommands=["quote","header","align","list","indent","outdent"];inlineBlockStylingCommands=["header","align"];requireSingleNodeToActivateStylingCommands=["quote","list"];multipleValueStylingCommands=["font","size","foreColor","backColor","link"];noUIUpdateStylingCommands=["foreColor","backColor","indent","outdent","link","insertImage","undo","redo","remove","insertHorizontalRule"];cannotCreateCursorCommands=["link"];insertCommands=["insertImage","insertHorizontalRule"];constructor(e,t){this.container=e,this.settings=t,this.commands=["bold","italic","underline","strikethrough","font","size","foreColor","backColor","sup","sub","link","quote","header","align","list","indent","outdent","insertImage","insertHorizontalRule","undo","redo"]||0,this.menubarSettings=[["bold","italic","underline","strikethrough","font","size","foreColor","backColor","sup","sub","link","remove"],["quote","header","align","list","indent","outdent"],["insertImage","insertHorizontalRule"],["undo","redo","openFindAndReplace"]]||0,this.snapshotInterval=5e3,this.historyLimit=50,this.supportedFonts=["Arial","Times New Roman","monospace","Helvetica"]||0,this.defaultFont="Arial",this.defaultSize=16,this.spellcheck=null==t.spellcheck||t.spellcheck,this.defaultImageWidth="300px",this.iconDirectory=t.iconDirectory;const n=document.createElement("div");n.innerHTML=this.invisible,this.invisibleParsed=n.innerHTML}hash(e,t=0){let n=3735928559^t,i=1103547991^t;for(let t,o=0;o<e.length;o++)t=e.charCodeAt(o),n=Math.imul(n^t,2654435761),i=Math.imul(i^t,1597334677);return n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(n^n>>>13,3266489909),4294967296*(2097151&i)+(n>>>0)}createCursor(){const e=document.createElement("span");return e.setAttribute("class","editor-temp-cursor"),e.innerHTML=this.invisible,this.currentCursor=e,e}applySizeStyles(){this.editor.style.width="600px",this.menubar.style.width="600px",this.settings.height?this.editor.style.height=this.settings.height:this.settings.minHeight?this.editor.style.minHeight=this.settings.minHeight:this.editor.style.minHeight="600px"}applyDefaultFont(){this.editor.style.fontFamily=this.defaultFont}applyDefaultSize(){this.editor.style.fontSize=String(this.defaultSize)+"px"}createMenubar(){iconPathFromName=iconPathFromName.bind(this),this.menubar=document.createElement("div"),this.menubar.setAttribute("id","editor-menubar"),this.menubar.setAttribute("role","toolbar"),this.menubar.setAttribute("aria-label","Editor menubar"),this.container.append(this.menubar),this.menubarOptions={};for(const n of this.menubarSettings){for(const i of n)switch(i){case"bold":this.menubarOptions.bold=document.createElement("button"),this.menubarOptions.bold.setAttribute("id","editor-menubar-option-bold"),this.menubarOptions.bold.innerHTML=this.iconDirectory?EditorIcons.bold:"B",this.menubarOptions.bold.addEventListener("click",this.bold.bind(this)),this.menubarOptions.bold.setAttribute("title","Bold"),this.menubarOptions.bold.setAttribute("aria-pressed","false"),this.menubarOptions.bold.setAttribute("aria-label","Editor toggle bold"),this.menubar.append(this.menubarOptions.bold);break;case"italic":this.menubarOptions.italic=document.createElement("button"),this.menubarOptions.italic.setAttribute("id","editor-menubar-option-italic"),this.menubarOptions.italic.innerHTML=this.iconDirectory?iconPathFromName("italic"):"I",this.menubarOptions.italic.addEventListener("click",this.italic.bind(this)),this.menubarOptions.italic.setAttribute("title","Italic"),this.menubarOptions.italic.setAttribute("aria-pressed","false"),this.menubarOptions.italic.setAttribute("aria-label","Editor toggle italic"),this.menubar.append(this.menubarOptions.italic);break;case"underline":this.menubarOptions.underline=document.createElement("button"),this.menubarOptions.underline.setAttribute("id","editor-menubar-option-underline"),this.menubarOptions.underline.innerHTML=this.iconDirectory?iconPathFromName("underline"):"U",this.menubarOptions.underline.addEventListener("click",this.underline.bind(this)),this.menubarOptions.underline.setAttribute("title","Underline"),this.menubarOptions.underline.setAttribute("aria-pressed","false"),this.menubarOptions.underline.setAttribute("aria-label","Editor toggle underline"),this.menubar.append(this.menubarOptions.underline);break;case"strikethrough":this.menubarOptions.strikethrough=document.createElement("button"),this.menubarOptions.strikethrough.setAttribute("id","editor-menubar-option-strikethrough"),this.menubarOptions.strikethrough.innerHTML=this.iconDirectory?iconPathFromName("strikethrough"):"S",this.menubarOptions.strikethrough.addEventListener("click",this.strikethrough.bind(this)),this.menubarOptions.strikethrough.setAttribute("title","Strikethrough"),this.menubarOptions.strikethrough.setAttribute("aria-pressed","false"),this.menubarOptions.strikethrough.setAttribute("aria-label","Editor toggle strikethrough"),this.menubar.append(this.menubarOptions.strikethrough);break;case"font":var e=[];for(const t of this.supportedFonts){const n=document.createElement("div");n.innerHTML=t,n.style.fontFamily=t,n.setAttribute("value",t),n.setAttribute("title",t),n.setAttribute("aria-label","Editor select font "+t),e.push({name:t,content:n})}this.menubarOptions.font=this.MimirUI.dropdownList(e,this.font.bind(this)),this.menubarOptions.font.list.setAttribute("id","editor-menubar-option-font"),this.menubarOptions.font.setValue(this.defaultFont),this.menubar.append(this.menubarOptions.font.list),this.menubarOptions.font.list.setAttribute("title","Font"),this.menubarOptions.font.list.setAttribute("aria-label","Editor select font"),this.menubarOptions.font.list.style.width="130px";break;case"size":const{numberInput:n,input:i,plus:o,minus:s}=this.MimirUI.numberInput(1,200);this.menubarOptions.size=i,n.setAttribute("id","editor-menubar-option-size"),this.menubarOptions.size.value=this.defaultSize,this.menubarOptions.size.addEventListener("change",this.size.bind(this)),this.menubarOptions.size.setAttribute("title","Size"),this.menubarOptions.size.setAttribute("aria-label","Editor change size"),o.setAttribute("title","Increase Size"),o.setAttribute("aria-label","Editor change size increase"),s.setAttribute("title","Decrease Size"),s.setAttribute("aria-label","Editor change size decrease"),this.menubar.append(n);break;case"foreColor":const r=document.createElement("button");r.innerHTML=this.iconDirectory?iconPathFromName("a"):"A",this.iconDirectory?r.childNodes[0].style.borderBottom="2px solid rgb(255, 0, 0)":r.style.textDecorationColor="rgb(255, 0, 0)",r.classList.add("editor-menubar-option-fore-color-button"),r.addEventListener("click",function(){this.foreColor(t.getValue())}.bind(this));const a=document.createElement("button");a.innerHTML="&#9660";var t=this.MimirUI.colorInput(this.foreColor.bind(this),a,200,40,200);this.menubarOptions.foreColor=t,t.colorInput.setAttribute("id","editor-menubar-option-fore-color");const d=document.createElement("div");d.classList.add("editor-menubar-option-fore-color-button-container"),d.append(r,t.dropdown.button),t.colorInput.prepend(d),t.colorInput.setAttribute("title","Foreground Color"),t.colorInput.setAttribute("aria-label","Editor change foreground color"),this.menubar.append(t.colorInput);break;case"backColor":const l=document.createElement("button");l.innerHTML=this.iconDirectory?iconPathFromName("fill"):"&#9639;",this.iconDirectory?l.childNodes[0].style.borderBottom="2px solid rgb(255, 0, 0)":l.style.textDecorationColor="rgb(255, 0, 0)",l.classList.add("editor-menubar-option-back-color-button"),l.addEventListener("click",function(){this.backColor(h.getValue())}.bind(this));const c=document.createElement("button");c.innerHTML="&#9660";const h=this.MimirUI.colorInput(this.backColor.bind(this),c,200,40,200);this.menubarOptions.backColor=h,h.colorInput.setAttribute("id","editor-menubar-option-back-color");const u=document.createElement("div");u.classList.add("editor-menubar-option-back-color-button-container"),u.append(l,h.dropdown.button),h.colorInput.prepend(u),h.colorInput.setAttribute("title","Background Color"),h.colorInput.setAttribute("aria-label","Editor change background color"),this.menubar.append(h.colorInput);break;case"sup":this.menubarOptions.sup=document.createElement("button"),this.menubarOptions.sup.setAttribute("id","editor-menubar-option-sup"),this.menubarOptions.sup.innerHTML=this.iconDirectory?iconPathFromName("superscript"):"x<sup>2</sup>",this.menubarOptions.sup.addEventListener("click",this.sup.bind(this)),this.menubarOptions.sup.setAttribute("title","Superscript"),this.menubarOptions.sup.setAttribute("aria-pressed","false"),this.menubarOptions.sup.setAttribute("aria-label","Editor toggle superscript"),this.menubar.append(this.menubarOptions.sup);break;case"sub":this.menubarOptions.sub=document.createElement("button"),this.menubarOptions.sub.setAttribute("id","editor-menubar-option-sub"),this.menubarOptions.sub.innerHTML=this.iconDirectory?iconPathFromName("subscript"):"x<sub>2</sub>",this.menubarOptions.sub.addEventListener("click",this.sub.bind(this)),this.menubarOptions.sub.setAttribute("title","Subscript"),this.menubarOptions.sub.setAttribute("aria-pressed","false"),this.menubarOptions.sub.setAttribute("aria-label","Editor toggle subscript"),this.menubar.append(this.menubarOptions.sub);break;case"link":const m=document.createElement("button");m.innerHTML=this.iconDirectory?iconPathFromName("link"):"&#128279;",m.classList.add("editor-menubar-option-link-button");const p=this.MimirUI.linkInput(this.link.bind(this),m);this.menubarOptions.link=p,p.linkInput.setAttribute("id","editor-menubar-option-link"),p.linkInput.setAttribute("title","Hyperlink"),p.linkInput.setAttribute("aria-pressed","false"),p.linkInput.setAttribute("aria-label","Editor insert link"),this.menubar.append(p.linkInput);break;case"quote":this.menubarOptions.quote=document.createElement("button"),this.menubarOptions.quote.setAttribute("id","editor-menubar-option-quote"),this.menubarOptions.quote.innerHTML=this.iconDirectory?iconPathFromName("quote"):'"',this.menubarOptions.quote.addEventListener("click",this.quote.bind(this)),this.menubarOptions.quote.setAttribute("title","Blockquote"),this.menubarOptions.quote.setAttribute("aria-pressed","false"),this.menubarOptions.quote.setAttribute("aria-label","Editor toggle blockquote"),this.menubar.append(this.menubarOptions.quote);break;case"header":e=[];const g=(e,t)=>{const n=document.createElement("strong");return n.innerHTML=`<span style="font-size: ${e}px" title="${t}" aria-label="Editor select header ${t}">${t}</span>`,n},f=e=>{const t=document.createElement("div");return t.innerHTML=`<span aria-label="Editor select header ${e}">${e}</span>`,t},N={Paragraph:[f("Paragraph"),f("Paragraph")],H1:[g(36,"Heading 1"),f("Heading 1")],H2:[g(24,"Heading 2"),f("Heading 2")],H3:[g(18,"Heading 3"),f("Heading 3")],H4:[g(16,"Heading 4"),f("Heading 4")],H5:[g(14,"Heading 5"),f("Heading 5")],H6:[g(12,"Heading 6"),f("Heading 6")]};for(const t of["Paragraph","H1","H2","H3","H4","H5","H6"])e.push({name:t,content:N[t][0],buttonDisplay:N[t][1]});this.menubarOptions.header=this.MimirUI.dropdownList(e,this.header.bind(this)),this.menubarOptions.header.list.setAttribute("id","editor-menubar-option-header"),this.menubarOptions.header.list.setAttribute("title","Header"),this.menubarOptions.header.list.setAttribute("aria-label","Editor select header"),this.menubar.append(this.menubarOptions.header.list);break;case"align":e=[];for(const t of["Left","Right","Center","Justify"]){const n=document.createElement("div");n.innerHTML=this.iconDirectory?iconPathFromName("align-"+t.toLowerCase()):t,n.setAttribute("value",t.toLowerCase()),n.setAttribute("title",t),n.setAttribute("aria-label","Editor change alignment "+t),e.push({name:t.toLowerCase(),content:n})}this.menubarOptions.align=this.MimirUI.dropdownList(e,this.align.bind(this)),this.menubarOptions.align.list.setAttribute("id","editor-menubar-option-align"),this.menubarOptions.align.list.setAttribute("title","Alignment"),this.menubarOptions.align.list.setAttribute("aria-label","Editor change alignment"),this.menubar.append(this.menubarOptions.align.list);break;case"list":this.menubarOptions.listOrdered=document.createElement("button"),this.menubarOptions.listOrdered.setAttribute("id","editor-menubar-option-ordered-list"),this.menubarOptions.listOrdered.innerHTML=this.iconDirectory?iconPathFromName("list-ordered"):"OL",this.menubarOptions.listOrdered.addEventListener("click",this.listOrdered.bind(this)),this.menubarOptions.listOrdered.setAttribute("title","Ordered List"),this.menubarOptions.listOrdered.setAttribute("aria-label","Editor toggle ordered list"),this.menubar.append(this.menubarOptions.listOrdered),this.menubarOptions.listUnordered=document.createElement("button"),this.menubarOptions.listUnordered.setAttribute("id","editor-menubar-option-unordered-list"),this.menubarOptions.listUnordered.innerHTML=this.iconDirectory?iconPathFromName("list-unordered"):"UL",this.menubarOptions.listUnordered.addEventListener("click",this.listUnordered.bind(this)),this.menubarOptions.listUnordered.setAttribute("title","Unordered List"),this.menubarOptions.listUnordered.setAttribute("aria-label","Editor toggle unordered list"),this.menubar.append(this.menubarOptions.listUnordered);break;case"indent":this.menubarOptions.indent=document.createElement("button"),this.menubarOptions.indent.setAttribute("id","editor-menubar-option-indent"),this.menubarOptions.indent.innerHTML=this.iconDirectory?iconPathFromName("indent"):">",this.menubarOptions.indent.addEventListener("click",this.indent.bind(this)),this.menubarOptions.indent.setAttribute("title","Indent"),this.menubarOptions.indent.setAttribute("aria-label","Editor increase indent"),this.menubar.append(this.menubarOptions.indent);break;case"outdent":this.menubarOptions.outdent=document.createElement("button"),this.menubarOptions.outdent.setAttribute("id","editor-menubar-option-outdent"),this.menubarOptions.outdent.innerHTML=this.iconDirectory?iconPathFromName("outdent"):"<",this.menubarOptions.outdent.addEventListener("click",this.outdent.bind(this)),this.menubarOptions.outdent.setAttribute("title","Outdent"),this.menubarOptions.outdent.setAttribute("aria-label","Editor decrease indent"),this.menubar.append(this.menubarOptions.outdent);break;case"insertImage":const b=document.createElement("button");b.innerHTML=this.iconDirectory?iconPathFromName("image"):"&#128444;",b.classList.add("editor-menubar-option-image-button");const y=this.MimirUI.imageInput(this.insertImage.bind(this),b,this.imageObjectURLs);this.menubarOptions.insertImage=y,y.imageInput.setAttribute("id","editor-menubar-option-image"),y.imageInput.setAttribute("title","Insert Image"),y.imageInput.setAttribute("aria-label","Editor insert image"),this.menubar.append(y.imageInput);break;case"insertHorizontalRule":this.menubarOptions.hr=document.createElement("button"),this.menubarOptions.hr.setAttribute("id","editor-menubar-option-hr"),this.menubarOptions.hr.innerHTML=this.iconDirectory?iconPathFromName("hr"):"&#9135;",this.menubarOptions.hr.addEventListener("click",this.insertHR.bind(this)),this.menubarOptions.hr.setAttribute("title","Horizontal Line"),this.menubarOptions.hr.setAttribute("aria-label","Editor insert horizontal line"),this.menubar.append(this.menubarOptions.hr);break;case"undo":this.menubarOptions.undo=document.createElement("button"),this.menubarOptions.undo.setAttribute("id","editor-menubar-option-undo"),this.menubarOptions.undo.innerHTML=this.iconDirectory?iconPathFromName("undo"):"&#8630;",this.menubarOptions.undo.addEventListener("click",this.undo.bind(this)),this.menubarOptions.undo.setAttribute("title","Undo"),this.menubarOptions.undo.setAttribute("aria-label","Editor undo"),this.menubar.append(this.menubarOptions.undo);break;case"redo":this.menubarOptions.redo=document.createElement("button"),this.menubarOptions.redo.setAttribute("id","editor-menubar-option-redo"),this.menubarOptions.redo.innerHTML=this.iconDirectory?iconPathFromName("redo"):"&#8631;",this.menubarOptions.redo.addEventListener("click",this.redo.bind(this)),this.menubarOptions.redo.setAttribute("title","Redo"),this.menubarOptions.redo.setAttribute("aria-label","Editor redo"),this.menubar.append(this.menubarOptions.redo);break;case"remove":this.menubarOptions.remove=document.createElement("button"),this.menubarOptions.remove.setAttribute("id","editor-menubar-option-remove"),this.menubarOptions.remove.innerHTML=this.iconDirectory?iconPathFromName("remove"):"X",this.menubarOptions.remove.addEventListener("click",this.remove.bind(this)),this.menubarOptions.remove.setAttribute("title","Remove Styling"),this.menubarOptions.remove.setAttribute("aria-label","Editor remove all styling"),this.menubar.append(this.menubarOptions.remove);break;case"openFindAndReplace":this.menubarOptions.openFindAndReplace=document.createElement("button"),this.menubarOptions.openFindAndReplace.setAttribute("id","editor-menubar-option-open-find-and-replace"),this.menubarOptions.openFindAndReplace.innerHTML=this.iconDirectory?iconPathFromName("search"):"&#128270;",this.menubarOptions.openFindAndReplace.addEventListener("click",this.openFindAndReplace.bind(this)),this.menubarOptions.openFindAndReplace.setAttribute("title","Find and Replace"),this.menubarOptions.openFindAndReplace.setAttribute("aria-label","Editor open find and replace dialog"),this.menubarOptions.openFindAndReplace.setAttribute("aria-haspopup","true"),this.menubarOptions.openFindAndReplace.setAttribute("aria-expanded","false"),this.menubar.append(this.menubarOptions.openFindAndReplace)}if(this.menubarSettings.indexOf(n)==this.menubarSettings.length)continue;const i=document.createElement("div");i.classList.add("editor-menubar-spacer"),this.menubar.append(i)}}bindKeyboardEvents(){this.editor.addEventListener("keydown",function(e){if("b"==e.key.toLowerCase()&&(e.ctrlKey||e.metaKey))return e.preventDefault(),void this.bold();if("i"==e.key.toLowerCase()&&(e.ctrlKey||e.metaKey))return e.preventDefault(),void this.italic();if("u"==e.key.toLowerCase()&&(e.ctrlKey||e.metaKey))return e.preventDefault(),void this.underline();if("z"==e.key.toLowerCase()&&(e.ctrlKey||e.metaKey))return e.preventDefault(),void this.undo();if("y"==e.key.toLowerCase()&&(e.ctrlKey||e.metaKey))return e.preventDefault(),void this.redo();if("a"!=e.key.toLowerCase()||!e.ctrlKey&&!e.metaKey){if("f"==e.key.toLowerCase()&&(e.ctrlKey||e.metaKey))return e.preventDefault(),void this.openFindAndReplace();if("Enter"==e.key&&(this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0),"Tab"==e.key&&(e.preventDefault(),this.insertTab()),"ArrowLeft"==e.key||"Backspace"==e.key||"Delete"==e.key){const a=this.getRange();if(!a)return;if(this.currentCursor&&this.currentCursor.contains(a.commonAncestorContainer)){for(r=this.currentCursor;this.inEditor(r.parentNode)&&r.parentNode!=this.editor&&this.isEmpty(r.parentNode)&&(this.inlineStylingTags.includes(r.parentNode.tagName)||"SPAN"==r.parentNode.tagName);)r=r.parentNode;const e=this.leftSiblingIgnoreEmpty(r),t=this.rightSiblingIgnoreEmpty(r);if(this.blockTags.includes(r.parentNode.tagName)&&this.isEmpty(r.parentNode)&&!this.childlessTags.includes(r.parentNode.tagName))r.before(document.createElement("BR"));else if(e&&this.blockTags.includes(e.tagName)&&(!t||this.blockTags.includes(t.tagName))||t&&this.blockTags.includes(t.tagName)&&(!e||this.blockTags.includes(e.tagName))){t&&"BR"==t.tagName&&t.remove(),e&&"BR"==e.tagName&&e.remove();const n=document.createElement("div");n.append(document.createElement("br")),r.before(n)}return r.remove(),this.currentCursor=null,void this.updateMenubarOptions()}if(a.endContainer.nodeType==Node.TEXT_NODE)var t=a.endContainer.textContent.length;else t=a.endContainer.childNodes.length;if(0==a.startOffset&&a.endOffset>=t&&(a.startOffset!=a.endOffset||a.startContainer!=a.endContainer)&&"ArrowLeft"!=e.key||"Backspace"==e.key&&1==a.commonAncestorContainer.textContent.length&&a.endOffset>=1||"Delete"==e.key&&1==a.commonAncestorContainer.textContent.length&&0==a.endOffset){if(e.preventDefault(),0==a.startOffset&&a.endOffset>=t&&(a.startOffset!=a.endOffset||a.startContainer!=a.endContainer)){const e=a.extractContents();this.imageModule.getSelected()&&this.imageModule.deselect();const t=[],s=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);for(;s.nextNode();)t.push(s.currentNode);if(0==t.length)return;const d=[];var n=!0;for(const o of t)if(o.nodeType!=Node.TEXT_NODE||""!=o.textContent){r=o.parentNode;for(var i=[];r!=e;)i.push(...this.getStylingOfElement(r)),r=r.parentNode;if(n)d.push(...i),n=!1;else{for(const e of d.slice(0,d.length))i.some((t=>this.compareStyling(t,e)))||this.requireSingleNodeToActivateStylingCommands.includes(e.type)||d.splice(d.findIndex((t=>t.type==e.type)),1);for(const e of i)this.requireSingleNodeToActivateStylingCommands.includes(e.type)&&(d.some((t=>this.compareStyling(t,e)))||d.push(e))}}const l=this.createCursor();var o=l;for(const e of d){if(!this.inlineStylingCommands.includes(e.type))continue;const t=this.styleToElement(e);t.append(o),o=t}a.insertNode(o);const c=new Range;return c.selectNodeContents(l),c.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(c),void this.updateMenubarOptions()}const d=new Range,{nodes:l,startOffset:c,endOffset:h}=this.getTextNodesInRange(a);if(0==l.length)return;d.selectNode(l[0]);const u=this.detectStyling(d),m=this.createCursor();o=m;for(const e of u){if(!this.inlineStylingCommands.includes(e.type))continue;const t=this.styleToElement(e);t.append(o),o=t}if(a.startContainer.textContent="",this.imageModule.getSelected()&&this.imageModule.deselect(),a.startContainer.nodeType==Node.TEXT_NODE){if(((s=a.startContainer).nodeType==Node.ELEMENT_NODE&&(this.inlineStylingTags.includes(s.tagName)||"SPAN"==s.tagName)||this.inlineStylingTags.includes(s.parentNode.tagName)||"SPAN"==s.parentNode.tagName)&&(s=this.findLastParent(s,(e=>this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName))),a.startContainer!=s){const e=this.splitNodeAtChild(s,a.startContainer);s.after(o,e),this.isEmpty(e)&&e!=this.editor&&e.remove()}else s.after(o);s&&this.isEmpty(s)&&s!=this.editor&&s.remove()}else if(a.startContainer==this.editor)a.startContainer.prepend(o);else{var s;if(((s=a.startContainer).nodeType==Node.ELEMENT_NODE&&(this.inlineStylingTags.includes(s.tagName)||"SPAN"==s.tagName)||this.inlineStylingTags.includes(s.parentNode.tagName)||"SPAN"==s.parentNode.tagName)&&(s=this.findLastParent(s,(e=>this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName))),a.startContainer!=s){const e=this.splitNodeAtChild(s,a.startContainer);s.after(o,e),this.isEmpty(e)&&e!=this.editor&&e.remove()}else s.after(o);s&&this.isEmpty(s)&&s!=this.editor&&s.remove()}const p=new Range;p.selectNodeContents(m),p.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(p),this.scrollTextNodeIntoView(m)}this.updateMenubarOptions()}if(1==e.key.length&&!e.ctrlKey&&!e.metaKey){this.shouldTakeSnapshotOnNextChange&&(this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!1);const t=this.getRange();if(null!=t&&this.currentCursor&&this.currentCursor.contains(t.commonAncestorContainer)){e.preventDefault();const t=this.currentCursor,n=document.createTextNode(e.key);t.before(n),t.remove(),this.currentCursor=null;const i=new Range;return i.selectNodeContents(n),i.collapse(!1),document.getSelection().removeAllRanges(),document.getSelection().addRange(i),this.scrollTextNodeIntoView(n),void this.updateMenubarOptions()}}}else{if(this.rangeCache=null,this.currentCursor){for(var r=this.currentCursor;this.inEditor(r.parentNode)&&r.parentNode!=this.editor&&this.isEmpty(r.parentNode)&&(this.inlineStylingTags.includes(r.parentNode.tagName)||"SPAN"==r.parentNode.tagName);)r=r.parentNode;const e=this.leftSiblingIgnoreEmpty(r),t=this.rightSiblingIgnoreEmpty(r);if(this.blockTags.includes(r.parentNode.tagName)&&this.isEmpty(r.parentNode)&&!this.childlessTags.includes(r.parentNode.tagName))r.before(document.createElement("BR"));else if(e&&this.blockTags.includes(e.tagName)&&(!t||this.blockTags.includes(t.tagName))||t&&this.blockTags.includes(t.tagName)&&(!e||this.blockTags.includes(e.tagName))){t&&"BR"==t.tagName&&t.remove(),e&&"BR"==e.tagName&&e.remove();const n=document.createElement("div");n.append(document.createElement("br")),r.before(n)}r.remove(),this.currentCursor=null}this.editor.innerHTML=this.editor.innerHTML}}.bind(this))}bindInputEvents(){this.editor.addEventListener("beforeinput",function(e){if("formatBold"==e.inputType)return e.preventDefault(),void this.bold();if("formatItalic"==e.inputType)return e.preventDefault(),void this.italic();if("formatUnderline"==e.inputType)return e.preventDefault(),void this.underline();if("historyUndo"==e.inputType)return e.preventDefault(),void this.undo();if("historyRedo"==e.inputType)return e.preventDefault(),void this.redo();if("insertParagraph"==e.inputType){var t=this.handleEscapeBlockquote(e);(t|=this.handleEscapeLists(e))||this.handleEscapeCursorParagraph(e)}else"insertText"!=e.inputType&&!e.inputType.startsWith("deleteContent")||e.key||this.removeCursor()}.bind(this))}handleEscapeBlockquote(e){for(var t=this.getRange()?.commonAncestorContainer;!this.blockTags.includes(t.tagName)&&this.inEditor(t);)t=t.parentNode;if("DIV"==t.tagName||"P"==t.tagName||"BR"==t.tagName){for(var n=t;"BLOCKQUOTE"!=n.tagName&&this.inEditor(n.parentNode);)n=n.parentNode;"BLOCKQUOTE"==n.tagName&&(t=n)}if("BLOCKQUOTE"==t.tagName&&this.isEmptyOrLineBreak(t)){e.preventDefault();const n=document.createElement("div");if(n.append(...t.childNodes),t.after(n),t.remove(),t=n,this.currentCursor&&n.contains(this.currentCursor)){const e=new Range;return e.selectNodeContents(this.currentCursor),e.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),!0}const i=new Range;return i.setStart(t,0),document.getSelection().removeAllRanges(),document.getSelection().addRange(i),t.scrollIntoView(!1),!0}return!1}handleEscapeLists(e){for(var t=this.getRange()?.commonAncestorContainer;!this.blockTags.includes(t.tagName)&&this.inEditor(t);)t=t.parentNode;if("DIV"==t.tagName||"P"==t.tagName||"BR"==t.tagName){for(var n=t;"LI"!=n.tagName&&this.inEditor(n.parentNode);)n=n.parentNode;"LI"==n.tagName&&(t=n)}if("LI"==t.tagName&&this.isEmptyOrLineBreak(t)){e.preventDefault();const n=t.parentNode,i=Array.from(n.childNodes).slice(Array.from(n.childNodes).indexOf(t)+1,n.childNodes.length),o=n.cloneNode(!1);if(o.append(...i),n.after(t,o),this.isEmpty(o)&&o.remove(),this.isEmpty(n)&&n.remove(),!["UL","OL"].includes(t.parentNode.tagName))if("LI"==t.parentNode.tagName){const e=Array.from(t.parentNode.childNodes).slice(Array.from(t.parentNode.childNodes).indexOf(t)+1,t.parentNode.childNodes.length);t.parentNode.after(t,...e),t.previousSibling&&this.isEmpty(t.previousSibling)&&t.previousSibling.remove()}else{const e=document.createElement("div");e.append(...t.childNodes),t.after(e),t.remove(),t=e}if(this.currentCursor&&t.contains(this.currentCursor)){const e=new Range;return e.selectNodeContents(this.currentCursor),e.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),!0}const s=new Range;return s.setStart(t,0),document.getSelection().removeAllRanges(),document.getSelection().addRange(s),t.scrollIntoView(!1),!0}return!1}inlineSiblingsAfterNode(e){const t=[];for(;e.nextSibling&&!this.blockTags.includes(e.tagName);)e=e.nextSibling,t.push(e);return t}inlineSiblingsBeforeNode(e){const t=[];for(;e.previousSibling&&!this.blockTags.includes(e.tagName);)e=e.previousSibling,t.push(e);return t}handleEscapeCursorParagraph(e){const t=this.getRange();if(!t)return!1;if(!this.currentCursor||!this.currentCursor.contains(t.commonAncestorContainer))return!1;e.preventDefault();for(var n=t.commonAncestorContainer,i=null,o=null;!["LI"].includes(n.tagName)&&this.inEditor(n)&&n!=this.editor;)o=n,n=n.parentNode,this.blockTags.includes(n.tagName)&&n!=this.editor&&(i=n);if(n==this.editor){if(!i){if(o==this.currentCursor){const e=document.createElement("div");this.currentCursor.after(e),e.append(this.currentCursor);const t=new Range;return t.selectNodeContents(this.currentCursor),t.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(t),!0}const e=this.splitNodeAtChild(o,this.currentCursor,!0),t=this.inlineSiblingsAfterNode(o),n=document.createElement("div");n.append(e,...t),o.after(n);const i=document.createElement("div");if(o.after(i),i.append(o,...this.inlineSiblingsBeforeNode(o)),this.isEmpty(i)){for(var s=i;s.lastChild&&!this.childlessTags.includes(s.lastChild.tagName)&&s.lastChild.nodeType==Node.ELEMENT_NODE;)s=s.lastChild;s.append(document.createElement("br"))}const r=new Range;return r.selectNodeContents(this.currentCursor),r.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(r),!0}const e=this.splitNodeAtChild(i,this.currentCursor,!0);if(i.after(e),this.isEmpty(i)){for(s=i;s.lastChild&&!this.childlessTags.includes(s.lastChild.tagName)&&s.lastChild.nodeType==Node.ELEMENT_NODE;)s=s.lastChild;s.append(document.createElement("br"))}const t=new Range;return t.selectNodeContents(this.currentCursor),t.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(t),!0}const r=this.splitNodeAtChild(n,this.currentCursor,!0);if(n.after(r),this.isEmpty(n)){for(s=n;s.lastChild&&!this.childlessTags.includes(s.lastChild.tagName)&&s.lastChild.nodeType==Node.ELEMENT_NODE;)s=s.lastChild;s.append(document.createElement("br"))}const a=new Range;return a.selectNodeContents(this.currentCursor),a.collapse(),document.getSelection().removeAllRanges(),document.getSelection().addRange(a),!0}removeCursor(e=!0){const t=this.getRange();if(this.currentCursor&&this.currentCursor.contains(t.commonAncestorContainer)){for(var n=this.currentCursor;this.inEditor(n.parentNode)&&n.parentNode!=this.editor&&this.isEmpty(n.parentNode)&&(this.inlineStylingTags.includes(n.parentNode.tagName)||"SPAN"==n.parentNode.tagName);)n=n.parentNode;if(e){const e=this.leftSiblingIgnoreEmpty(n),t=this.rightSiblingIgnoreEmpty(n);if(this.blockTags.includes(n.parentNode.tagName)&&this.isEmpty(n.parentNode)&&!this.childlessTags.includes(n.parentNode.tagName))n.before(document.createElement("BR"));else if(e&&this.blockTags.includes(e.tagName)&&(!t||this.blockTags.includes(t.tagName))||t&&this.blockTags.includes(t.tagName)&&(!e||this.blockTags.includes(e.tagName))){t&&"BR"==t.tagName&&t.remove(),e&&"BR"==e.tagName&&e.remove();const i=document.createElement("div");i.append(document.createElement("br")),n.before(i)}}n.remove(),this.currentCursor=null,this.updateMenubarOptions()}}handleClickLink(e){const t=this.findClosestParent(e,(e=>"A"==e.tagName));if(!t)return;const n=t.getAttribute("href");n&&window.open(n)}bindClickEvents(){this.editor.addEventListener("click",function(e){e.ctrlKey&&this.handleClickLink(e.target)}.bind(this))}addStylingToNode(e,t){var n=e;for(const e of t){var i=this.styleToElement(e);i.append(n),n=i}return n}leftSibling(e){for(var t=e;this.inEditor(t)&&t!=this.editor;){if(t.previousSibling)return t.previousSibling;t=t.parentNode}return null}rightSibling(e){for(var t=e;this.inEditor(t)&&t!=this.editor;){if(t.nextSibling)return t.nextSibling;t=t.parentNode}return null}leftSiblingIgnoreEmpty(e){for(var t=e.previousSibling;t&&this.isEmpty(t);)t=t.previousSibling;return t}rightSiblingIgnoreEmpty(e){for(var t=e.nextSibling;t&&this.isEmpty(t);)t=t.nextSibling;return t}reconstructNodeContents(e,t,n,i=!0){const o=[];for(var s of Array.from(e.childNodes))if(s.nodeType==Node.TEXT_NODE||this.contentTags.includes(s.tagName)){for(var r=[],a=s,d=[];t.contains(a);){if(a.nodeType==Node.TEXT_NODE){a=a.parentNode;continue}var l=this.getStylingOfElement(a,!0);const e=(l=(l=l.filter((e=>!r.some((t=>e.type==t.type))))).filter((e=>!d.some((t=>e.type==t.target.type))))).filter((e=>"override"==e.type));l=(l=l.filter((e=>"override"!=e.type))).filter((e=>this.inlineStylingCommands.includes(e.type))),r.push(...l),d.push(...e),a=a.parentNode}if(s.nodeType==Node.ELEMENT_NODE){var c=s;if(s=document.createElement(c.tagName),"IMG"==c.tagName){if(c.getAttribute("src")){var h=c.getAttribute("src");if(h.toLowerCase().startsWith("http")||h.toLowerCase().startsWith("blob"))s.setAttribute("src",h);else if(h.toLowerCase().startsWith("data")){for(var u=h.split(",")[0].split(":")[1].split(";")[0],m=atob(h.split(",")[1]),p=[],g=0;g<m.length;g++)p.push(m.charCodeAt(g));const e=new Blob([new Uint8Array(p)],{type:u});h=URL.createObjectURL(e),s.setAttribute("src",h),this.imageObjectURLs.push(h)}}c.getAttribute("alt")&&s.setAttribute("alt",c.getAttribute("alt")),c.getAttribute("width")?s.style.width=c.getAttribute("width")+"px":c.style.width&&(s.style.width=c.style.width),c.getAttribute("height")?s.style.height=c.getAttribute("height")+"px":c.style.height&&(s.style.height=c.style.height)}}if(i){if(s.nodeType==Node.TEXT_NODE&&(s.textContent=s.textContent.replace(/[\t\n\r ]+/g," "),""==s.textContent.split(" ").join("")&&(" "==s.textContent[0]&&(s.textContent=s.textContent.slice(1,s.textContent.length))," "==s.textContent[s.textContent.length-1]&&(s.textContent=s.textContent.slice(0,s.textContent.length-1))),""==s.textContent))continue;s=this.addStylingToNode(s.cloneNode(),r),o.push(s)}else if(s.nodeType==Node.TEXT_NODE){const e=s.textContent.split(/\r?\n|\r|\n/g);var f=this.addStylingToNode(document.createTextNode(e[0]),r);""!=f.textContent&&o.push(f);for(const t of e.slice(1)){const e=document.createElement("br");""!=(f=this.addStylingToNode(document.createTextNode(t),r)).textContent?o.push(e,f):o.push(e)}}else s=this.addStylingToNode(s,r),o.push(s)}else if(s.nodeType==Node.ELEMENT_NODE){var N=i;if("PRE"==s.tagName&&(N=!1),["pre","pre-wrap","pre-line","break-spaces"].some((e=>s.style.whiteSpace.toLowerCase().includes(e)))&&(N=!1),("OL"==s.tagName||"UL"==s.tagName)&&!Array.from(s.childNodes).some((e=>"LI"==e.tagName)))continue;if(["H1","H2","H3","H4","H5","H6"].includes(s.tagName)){var b=document.createElement("div");const e=this.reconstructNodeContents(s,t,n,N);if(b.append(...e),s.style.marginLeft||s.style.paddingLeft){const e=s.style.marginLeft?s.style.marginLeft:s.style.paddingLeft;if(e.toLowerCase().endsWith("px")){const t=parseInt(e.slice(0,-2)),n=Math.ceil(t/40);for(g=0;g<n;g++){const e=document.createElement("div");e.style.marginLeft="40px",e.append(b),b=e}}}o.push(b),n.push({node:b,inlineBlockStyling:this.getStylingOfElement(s).filter((e=>this.inlineBlockStylingCommands.includes(e.type)))});continue}if(!this.basicAllowedTags.includes(s.tagName)){const e=this.reconstructNodeContents(s,t,n,N);if("address, article, aside, blockquote, canvas, dd, div, dl, dt, tr, fieldset, figcaption, figure, footer, form, h1, h2, h3, h4, h5, h6, header, hr, li, main, nav, noscript, ol, p, pre, section, table, tfoot, ul, video".toUpperCase().split(", ").includes(s.tagName.toUpperCase())){(b=document.createElement("div")).append(...e);const t=s.style.marginLeft?s.style.marginLeft:s.style.paddingLeft;if(t&&t.toLowerCase().endsWith("px")){const e=parseInt(t.slice(0,-2)),n=Math.ceil(e/40);for(g=0;g<n;g++){const e=document.createElement("div");e.style.marginLeft="40px",e.append(b),b=e}}o.push(b);continue}o.push(...e);continue}b=document.createElement(s.tagName);const e=this.getStylingOfElement(s).filter((e=>this.inlineBlockStylingCommands.includes(e.type)));0!=e.length&&this.blockTags.includes(b.tagName)&&n.push({node:b,inlineBlockStyling:e}),"A"==s.tagName&&s.getAttribute("href")&&"javascript:"!==s.getAttribute("href").trim().substring(0,11).toLowerCase()&&b.setAttribute("href",s.getAttribute("href"));const r=this.reconstructNodeContents(s,t,n,N);if(b.append(...r),"LI"==s.tagName&&s.style.listStyleType&&(b.style.listStyleType=s.style.listStyleType),"LI"==s.tagName&&s.style.listStyle&&s.style.listStyle.split(" ").length>0&&(b.style.listStyleType=s.style.listStyle.split(" ")[0]),["UL","OL"].includes(s.tagName)&&s.style.listStyleType&&r.forEach((e=>{e.style.listStyleType=s.style.listStyleType})),["UL","OL"].includes(s.tagName)&&s.style.listStyle&&s.style.listStyle.split(" ").length>0){const e=s.style.listStyle.split(" ")[0];r.forEach((t=>{t.style.listStyleType=e}))}if(s.style.marginLeft||s.style.paddingLeft){const e=s.style.marginLeft?s.style.marginLeft:s.style.paddingLeft;if(e.toLowerCase().endsWith("px")){const t=parseInt(e.slice(0,-2)),n=Math.ceil(t/40);for(g=0;g<n;g++){const e=document.createElement("div");e.style.marginLeft="40px",e.append(b),b=e}}}o.push(b)}return o}sanitize(e){const t=document.createElement("div");t.innerHTML=e;const n=[],i=this.reconstructNodeContents(t,t,n),o=[];for(const u of i)(0!=i.indexOf(u)&&i.indexOf(u)!=i.length-1||u.nodeType!=Node.TEXT_NODE||""!=u.textContent.split("\n").join("").split("\r").join("").split(" ").join(""))&&o.push(u);const s=document.createDocumentFragment();s.append(...o);for(const m of n)if(s.contains(m.node))for(const p of m.inlineBlockStyling){var r=null,a=null;const g=[];if("header"==p.type)var d="blockquote, ul, ol, li, h1, h2, h3, h4, h5, h6, div, p";else this.inlineBlockStylingCommands.includes(p.type)&&(d="blockquote, ul, ol, li, div, p");function f(e){if(e.nodeType==Node.ELEMENT_NODE&&d&&(e.matches(d)||e.querySelector(d)))for(const t of e.childNodes)f(t);else g.push(e)}for(var l of((f=f.bind(this))(m.node),g)){const N=l,b=l.nextSibling,y=this.styleToElement(p),v=document.createTextNode("");l.after(v),0==y.childNodes.length?y.appendChild(l):y.childNodes[0].appendChild(l),v.replaceWith(y),l=y,r&&r.nextSibling==l&&!this.blockTags.filter((e=>"BR"!=e)).includes(N.tagName)&&a==N?(r.append(...l.childNodes),l.remove()):r=l,a=b}}const c=s.querySelectorAll("div, p"),h=[];for(const E of c)!E.getAttribute("style")&&Array.from(E.childNodes).every((e=>this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName)||""==e.textContent))&&h.push(E);for(const C of h)C.after(...C.childNodes),C.remove();return Array.from(s.childNodes)}scrollTextNodeIntoView(e){const t=document.createElement("a");t.innerHTML=" ",e.after(t),t.scrollIntoView({block:"start"}),t.remove()}insertTab(){const e=this.getRange();if(!e)return;if(this.currentCursor&&this.currentCursor.contains(e.commonAncestorContainer)){const e=document.createTextNode("\t");this.currentCursor.after(e),this.currentCursor.remove(),this.currentCursor=null;const t=new Range;return t.selectNodeContents(e),t.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(t),void this.scrollTextNodeIntoView(e)}e.deleteContents(),this.imageModule.getSelected()&&this.imageModule.deselect();const t=document.createTextNode("\t");if(this.childlessTags.includes(e.commonAncestorContainer)){e.commonAncestorContainer.after(t),e.commonAncestorContainer.remove();const n=new Range;return n.selectNodeContents(t),n.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(n),void this.scrollTextNodeIntoView(t)}if(this.isEmptyOrLineBreak(e.commonAncestorContainer)){const n=e.commonAncestorContainer.querySelector("br");if(n){n.replaceWith(t);const e=new Range;return e.selectNodeContents(t),e.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(e),void this.scrollTextNodeIntoView(t)}}e.insertNode(t);const n=new Range;n.selectNodeContents(t),n.collapse(!1),window.getSelection().removeAllRanges(),window.getSelection().addRange(n),this.scrollTextNodeIntoView(t)}findLastParent(e,t){for(var n=e,i=null;this.inEditor(n)&&this.editor!=n;)t(n)&&(i=n),n=n.parentElement;return i}findClosestParent(e,t){for(var n=e;this.inEditor(n)&&this.editor!=n;){if(t(n))return n;n=n.parentElement}return null}insertHTML(e,t,n="end",i=null){if(t){if(0==(o=this.sanitize(t)).length)return}else{if(!i)return;var o=i}if(1==o.length&&""==o[0].textContent){"IMG"==o[0].tagName&&(n=null,this.onNodeDrawn(o[0],function(){this.imageModule.select(o[0])}.bind(this)));const e=o[0].querySelectorAll(this.contentTags.join(", "));1==e.length&&"IMG"==e[0].tagName&&(n=null,this.onNodeDrawn(e[0],function(){this.imageModule.select(e[0])}.bind(this)))}var s=e,r=null;for(var a of o){if(a.nodeType==Node.TEXT_NODE)s.after(a),s=a;else if(a.nodeType!=Node.ELEMENT_NODE||!this.inlineStylingTags.includes(a.tagName)&&"SPAN"!=a.tagName)if(a.nodeType==Node.ELEMENT_NODE&&"LI"==a.tagName)if(c=this.findLastParent(s,(e=>e.nodeType==Node.ELEMENT_NODE&&("OL"==e.tagName||"UL"==e.tagName)))){const e=document.createTextNode("");s.after(e);const t=this.splitNodeAtChild(c,e);s=c,s=a,c.append(a),null==t||this.isEmpty(t)||c.append(...t.childNodes)}else{var d=this.findLastParent(s,(e=>e.nodeType==Node.ELEMENT_NODE&&(this.blockTags.includes(a.tagName)||this.stylingTags.includes(e.tagName)||"SPAN"==e.tagName)));const e=document.createElement("li");if(e.append(a),a=e,d){const e=document.createTextNode("");s.after(e);const t=this.splitNodeAtChild(d,e);null!=t&&(this.isEmpty(t)||d.after(t)),s=a,d.after(a)}else s.after(a),s=a}else{if("BR"==a.tagName){const e=document.createElement("div");e.append(a),a=e}if(!r){var l=this.findClosestParent(s,(e=>e.tagName==a.tagName));if(l){const e=document.createTextNode("");s.after(e);const t=this.splitNodeAtChild(l,e);s=l;const n=Array.from(a.childNodes).filter((e=>!this.isEmpty(e)));this.isEmpty(s.lastChild)?(s.lastChild.remove(),s=0!=n.length?n[n.length-1]:s,l.append(...n),null==t||this.isEmpty(t)||l.append(...t.childNodes),r=s):(s=0!=n.length?n[n.length-1]:s,l.append(...n),null==t||this.isEmpty(t)||l.append(...t.childNodes),r=s);continue}}var c;if(c=this.findLastParent(s,(e=>e.nodeType==Node.ELEMENT_NODE&&(this.blockTags.includes(a.tagName)||this.stylingTags.includes(e.tagName)||"SPAN"==e.tagName)))){const e=document.createTextNode("");s.after(e);const t=this.splitNodeAtChild(c,e);null!=t&&(this.isEmpty(t)||c.after(t)),s=c}s.after(a),this.isEmpty(s)&&s.remove(),s=a}else{var h=this.findLastParent(s,(e=>e.nodeType==Node.ELEMENT_NODE&&(this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName)));if(h){const e=document.createTextNode("");s.after(e);const t=this.splitNodeAtChild(h,e);null!=t&&(this.isEmpty(t)||h.after(t)),s=h}s.after(a),this.isEmpty(s)&&s.remove(),s=a}r||(r=s)}if("end"==n){const e=new Range;return e.selectNodeContents(s),e.collapse(!1),e}if("all"==n){const e=new Range;return e.setStart(r,0),e.setEndAfter(s),e}}bindPasteEvents(){this.editor.addEventListener("paste",function(e){if(this.saveHistory(),this.imageModule.deselect(),this.removeCursor(!1),e.clipboardData.getData("text/html")){e.preventDefault();const t=this.getRange();if(null==t)return;t.deleteContents(),this.imageModule.getSelected()&&this.imageModule.deselect();const n=document.createTextNode("");if(t.startContainer.nodeType==Node.TEXT_NODE){const e=document.createTextNode(t.startContainer.textContent.slice(t.startOffset,t.startContainer.textContent.length));t.startContainer.textContent=t.startContainer.textContent.slice(0,t.startOffset),t.startContainer.after(n,e)}else 0==t.startOffset?this.childlessTags.includes(t.startContainer.tagName)?t.startContainer.after(n):t.startContainer.prepend(n):t.startContainer.childNodes[t.startOffset-1].after(n);const i=this.insertHTML(n,e.clipboardData.getData("text/html"));i&&(document.getSelection().removeAllRanges(),document.getSelection().addRange(i))}}.bind(this))}bindDragEvents(){this.editor.addEventListener("drag",function(e){this.dragRangeToRemove=this.getRange(),console.log("DRAG",this.dragRangeToRemove)}.bind(this)),this.editor.addEventListener("dragend",function(e){this.dragRangeToRemove=null,console.log("DROP",this.dragRangeToRemove)}.bind(this)),this.editor.addEventListener("drop",function(e){if(this.saveHistory(),this.imageModule.deselect(),this.removeCursor(!1),console.log("DROP",this.dragRangeToRemove),e.dataTransfer.getData("text/html")){if(e.preventDefault(),document.caretRangeFromPoint)var t=document.caretRangeFromPoint(e.clientX,e.clientY);else{if(!document.caretPositionFromPoint)return void console.error("Cannot find selection drop range. Try using a newer browser.");{const n=document.caretPositionFromPoint(e.clientX,e.clientY);if(t=document.createRange(),!n)return;(t=document.createRange()).setStart(n.offsetNode,n.offset),t.setEnd(n.offsetNode,n.offset)}}if(!this.inEditor(t.commonAncestorContainer))return;const r=this.dragRangeToRemove,a=document.createTextNode("");if(r){var n=r.startContainer,i=r.startOffset,o=r.endContainer,s=r.endOffset;if(t.startContainer.nodeType==Node.TEXT_NODE){const e=t.startOffset,r=document.createTextNode(t.startContainer.textContent.slice(e,t.startContainer.textContent.length));t.startContainer.textContent=t.startContainer.textContent.slice(0,e),t.startContainer.after(a,r),n==t.startContainer?i>=e&&(n=r,i-=e):n==t.startContainer.parentNode&&i>=Array.from(a.parentNode.childNodes).indexOf(a)&&(i+=2),o==t.startContainer?s>=e&&(o=r,s-=e):o==t.startContainer.parentNode&&s>=Array.from(a.parentNode.childNodes).indexOf(a)&&(s+=2)}else 0==t.startOffset?this.childlessTags.includes(t.startContainer.tagName)?(t.startContainer.before(a),n==t.startContainer.parentNode&&i>=Array.from(a.parentNode.childNodes).indexOf(a)&&(i+=1),o==t.startContainer.parentNode&&s>=Array.from(a.parentNode.childNodes).indexOf(a)&&(s+=1)):(t.startContainer.prepend(a),n==t.startContainer&&i>=t.startOffset&&(i+=1),o==t.startContainer&&s>=t.startOffset&&(s+=1)):(t.startContainer.childNodes[t.startOffset-1].after(a),n==t.startContainer&&i>=t.startOffset&&(i+=1),o==t.startContainer&&s>=t.startOffset&&(s+=1));const e=new Range;if(e.setStart(n,i),e.setEnd(o,s),e.intersectsNode(a))return void console.error("Drag source contains drop location.");e.deleteContents(),this.imageModule.getSelected()&&this.imageModule.deselect()}else if(t.startContainer.nodeType==Node.TEXT_NODE){const e=t.startOffset,n=document.createTextNode(t.startContainer.textContent.slice(e,t.startContainer.textContent.length));t.startContainer.textContent=t.startContainer.textContent.slice(0,e),t.startContainer.after(a,n)}else 0==t.startOffset?this.childlessTags.includes(t.startContainer.tagName)?t.startContainer.before(a):t.startContainer.prepend(a):t.startContainer.childNodes[t.startOffset-1].after(a);const d=e.dataTransfer.getData("text/html"),l=this.insertHTML(a,d,"all");l&&(document.getSelection().removeAllRanges(),document.getSelection().addRange(l))}}.bind(this))}updateMenubarOptions(){const e=this.getRange();if(null==e)return;const t=this.detectStyling(e);for(const e of this.commands)"font"!=e?"header"!=e?"align"!=e?"size"!=e?this.noUIUpdateStylingCommands.includes(e)||("list"!=e?t.some((t=>t.type==e))?this.menubarOptions[e].classList.contains("editor-pressed")||this.menubarOptions[e].classList.add("editor-pressed"):this.menubarOptions[e].classList.contains("editor-pressed")&&this.menubarOptions[e].classList.remove("editor-pressed"):(t.find((e=>"list"==e.type&&"ordered"==e.listType))?this.menubarOptions.listOrdered.classList.contains("editor-pressed")||this.menubarOptions.listOrdered.classList.add("editor-pressed"):this.menubarOptions.listOrdered.classList.remove("editor-pressed"),t.find((e=>"list"==e.type&&"unordered"==e.listType))?this.menubarOptions.listUnordered.classList.contains("editor-pressed")||this.menubarOptions.listUnordered.classList.add("editor-pressed"):this.menubarOptions.listUnordered.classList.remove("editor-pressed"))):this.menubarOptions.size.value=t.find((e=>"size"==e.type))?t.find((e=>"size"==e.type)).size:this.defaultSize:this.menubarOptions.align.setValue(t.find((e=>"align"==e.type))?t.find((e=>"align"==e.type)).direction:"left"):this.menubarOptions.header.setValue(t.find((e=>"header"==e.type))?t.find((e=>"header"==e.type)).level:"Paragraph"):this.menubarOptions.font.setValue(t.find((e=>"font"==e.type))?t.find((e=>"font"==e.type)).family:"")}onChangeSelect(){var e=this.getRange();if(null!=e){if(this.currentCursor&&!this.currentCursor.contains(e.commonAncestorContainer)){for(var t=this.currentCursor;this.inEditor(t.parentNode)&&t.parentNode!=this.editor&&this.isEmpty(t.parentNode)&&(this.inlineStylingTags.includes(t.parentNode.tagName)||"SPAN"==t.parentNode.tagName);)t=t.parentNode;const e=this.leftSiblingIgnoreEmpty(t),n=this.rightSiblingIgnoreEmpty(t);if(this.blockTags.includes(t.parentNode.tagName)&&this.isEmpty(t.parentNode)&&!this.childlessTags.includes(t.parentNode.tagName))t.before(document.createElement("BR"));else if(e&&this.blockTags.includes(e.tagName)&&(!n||this.blockTags.includes(n.tagName))||n&&this.blockTags.includes(n.tagName)&&(!e||this.blockTags.includes(e.tagName))){n&&"BR"==n.tagName&&n.remove(),e&&"BR"==e.tagName&&e.remove();const i=document.createElement("div");i.append(document.createElement("br")),t.before(i)}t.remove(),this.currentCursor=null}this.updateMenubarOptions()}}bindSelectEvents(){const e=this.onChangeSelect.bind(this);this.editor.addEventListener("focus",function(t){e(),document.addEventListener("selectionchange",e)}.bind(this)),this.editor.addEventListener("focusout",function(t){const n=document.getSelection();if(0!=n.rangeCount){const e=n.getRangeAt(0);this.editor.contains(e.commonAncestorContainer)&&(this.rangeCache=e)}e(),document.removeEventListener("selectionchange",e)}.bind(this)),this.editor.addEventListener("click",function(e){if(3==e.detail){const e=this.getRange();for(var t=e.startContainer,n=e.startOffset,i=e.endContainer,o=e.endOffset;i[o]&&this.isEmpty(i[o]);)i==t&&o==n&&(n-=1),o-=1;if(0==o&&i!=this.editor&&(o!=n||i!=t)&&!this.childlessTags.includes(i.tagName))for(;0==o&&i!=this.editor;)for(o=Array.from(i.parentNode.childNodes).indexOf(i),i=i.parentNode;i[o]&&this.isEmpty(i[o]);)i==t&&o==n&&(n-=1),o-=1;i.childNodes[o-1]&&(o=(i=i.childNodes[o-1]).nodeType==Node.ELEMENT_NODE?i.childNodes.length:i.textContent.length);const s=new Range;s.setStart(t,n),s.setEnd(i,o),document.getSelection().removeAllRanges(),document.getSelection().addRange(s)}}.bind(this))}bindSaveHistoryInterval(){setInterval(function(){this.saveHistory()}.bind(this),this.snapshotInterval)}bindExternalClickEvents(){document.addEventListener("mousedown",function(){const e=document.getSelection();if(0!=e.rangeCount){const t=e.getRangeAt(0);this.editor.contains(t.commonAncestorContainer)&&(this.rangeCache=t)}}.bind(this)),document.addEventListener("keydown",function(e){!e.metaKey&&!e.ctrlKey||"z"!=e.key&&"y"!=e.key||e.preventDefault()}.bind(this))}inEditor(e){return this.editor.contains(e)}returnFallbackRange(){const e=new Range;return e.setStart(this.editor,0),e.setEnd(this.editor,0),e}getRange(){if(this.imageModule&&this.imageModule.getSelected()&&this.inEditor(this.imageModule.getSelected())){const e=new Range;return e.selectNode(this.imageModule.getSelected()),e}const e=window.getSelection();if(0==e.rangeCount)return this.rangeCache?this.rangeCache:this.returnFallbackRange();const t=e.getRangeAt(0);return this.editor.contains(t.commonAncestorContainer)?t:this.rangeCache?this.rangeCache:this.returnFallbackRange()}getTextNodesInRange(e){if(null==e)return null;const t=new Range;t.setStart(e.startContainer,e.startOffset),t.setEnd(e.endContainer,e.endOffset);const n=[];for(var i=t.startContainer,o=t.startOffset,s=t.endOffset;i.nodeType==Node.ELEMENT_NODE&&!this.childlessTags.includes(i.tagName)&&0!=i.childNodes.length;)o==i.childNodes.length?o=(i=i.childNodes[o-1]).nodeType==Node.ELEMENT_NODE?this.childlessTags.includes(i.tagName)?1:i.childNodes.length:i.textContent.length:(i=i.childNodes[o],o=0);if(0==t.endOffset&&t.endContainer!=this.editor&&(t.endOffset!=t.startOffset||t.endContainer!=t.startContainer))for(;0==t.endOffset&&t.endContainer!=this.editor;){const e=Array.from(t.endContainer.parentNode.childNodes).indexOf(t.endContainer),n=t.endContainer.parentNode;t.setEnd(n,e)}for(var r=!1;this.inEditor(i)&&(!r||t.endContainer.contains(i)&&t.isPointInRange(i,0));)if((i.nodeType==Node.TEXT_NODE||this.childlessTags.includes(i.tagName))&&n.push(i),t.endContainer.contains(i)&&(r=!0),i.firstChild)i=i.firstChild;else if(i.nextSibling)i=i.nextSibling;else{for(;!i.nextSibling&&this.inEditor(i);)i=i.parentNode;i=i.nextSibling}if(t.endContainer.nodeType!=Node.TEXT_NODE&&this.inEditor(t.endContainer)&&n.slice(-1)[0]&&(s=1==t.comparePoint(n.slice(-1)[0],0)?0:this.childlessTags.includes(n.slice(-1)[0].tagName)?1:n.slice(-1)[0].textContent.length),t.endContainer.childNodes&&t.endContainer.childNodes[t.endOffset]&&this.childlessTags.includes(this.firstChildlessChild(t.endContainer.childNodes[t.endOffset]).tagName)){const e=this.firstChildlessChild(t.endContainer.childNodes[t.endOffset]);n.includes(e)||n[n.length-1]&&n[n.length-1].contains(e)||(n.push(e),s=1)}return{nodes:n,startOffset:o,endOffset:s}}styleToElement(e){switch(e.type){case"bold":return document.createElement("strong");case"italic":return document.createElement("em");case"underline":return document.createElement("u");case"strikethrough":return document.createElement("s");case"font":return(t=document.createElement("span")).style.fontFamily=e.family,t;case"size":return(t=document.createElement("span")).style.fontSize=String(e.size)+"px",t;case"foreColor":return(t=document.createElement("span")).style.color=e.color,t;case"backColor":return(t=document.createElement("span")).style.backgroundColor=e.color,t;case"sup":return document.createElement("sup");case"sub":return document.createElement("sub");case"link":return(t=document.createElement("a")).setAttribute("href",e.url),t;case"quote":return document.createElement("blockquote");case"header":return document.createElement(e.level);case"align":return(t=document.createElement("div")).style.textAlign=e.direction,t;case"list":var t=document.createElement("ordered"==e.listType?"ol":"ul");const n=document.createElement("li");return t.append(n),t}}getStylingOfElement(e,t=!1){if(e.nodeType!=Node.ELEMENT_NODE)return[];var n=[];switch(e.tagName){case"STRONG":case"B":n.push({type:"bold"});break;case"EM":case"I":case"VAR":n.push({type:"italic"});break;case"U":n.push({type:"underline"});break;case"S":n.push({type:"strikethrough"});break;case"FONT":var i;if(e.getAttribute("face")&&(i=(i=(i=(i=e.getAttribute("face")).split("&quot;")).map((e=>e.split('"').join("")))).map((e=>e.split("'").join(""))),n.push({type:"font",family:i})),e.getAttribute("size")&&+e.getAttribute("size")!=Number.NaN){var o=parseInt(e.getAttribute("size")),s=null;"+"==e.getAttribute("size").trim()[0]?s="plus":"-"==e.getAttribute("size").trim()[0]&&(s="minus"),"plus"!=s&&"minus"!=s||(o=3+o),o<1?o=1:o>7&&(o=7);var r=[10,13,16,18,24,32,48][o-1];n.push({type:"size",size:r})}e.getAttribute("color")&&n.push({type:"foreColor",color:e.getAttribute("color")});break;case"SUP":n.push({type:"sup"});break;case"SUB":n.push({type:"sub"});break;case"A":n.push({type:"link",url:e.getAttribute("href")||""});break;case"BLOCKQUOTE":n.push({type:"quote"});break;case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":n.push({type:"header",level:e.tagName}),t&&n.push({type:"override",target:{type:"size"}});break;case"UL":n.push({type:"list",listType:"unordered"});break;case"OL":n.push({type:"list",listType:"ordered"})}if("700"==e.style.fontWeight||"bold"==e.style.fontWeight.toLowerCase()?n.some((e=>"bold"==e.type))||n.push({type:"bold"}):"400"!=e.style.fontWeight&&"normal"!=e.style.fontWeight.toLowerCase()||(n.some((e=>"bold"==e.type))&&n.splice(n.findIndex((e=>"bold"==e.type)),1),t&&n.push({type:"override",target:{type:"bold"}})),"italic"==e.style.fontStyle.toLowerCase()?n.some((e=>"italic"==e.type))||n.push({type:"italic"}):"normal"==e.style.fontStyle.toLowerCase()&&(n.some((e=>"italic"==e.type))&&n.splice(n.findIndex((e=>"italic"==e.type)),1),t&&n.push({type:"override",target:{type:"italic"}})),e.style.textDecoration.toLowerCase().includes("underline")&&(n.some((e=>"underline"==e.type))||n.push({type:"underline"})),e.style.textDecoration.toLowerCase().includes("line-through")&&(n.some((e=>"strikethrough"==e.type))||n.push({type:"strikethrough"})),e.style.fontFamily&&(i=(i=(i=(i=e.style.fontFamily).split("&quot;").join("")).split('"').join("")).split("'").join(""),n.some((e=>"font"==e.type))||n.push({type:"font",family:i})),e.style.fontSize&&(o=String(e.style.fontSize).trim().toLowerCase()).endsWith("px")&&+o.slice(0,-2)!=Number.NaN&&(r=parseFloat(o.slice(0,-2)),n.some((e=>"size"==e.type))||n.push({type:"size",size:r})),e.style.color&&(n.some((e=>"foreColor"==e.type))||n.push({type:"foreColor",color:e.style.color})),e.style.backgroundColor&&(n.some((e=>"backColor"==e.type))||n.push({type:"backColor",color:e.style.backgroundColor})),e.style.textAlign){var a=e.style.textAlign.toLowerCase();n.some((e=>"align"==e.type))||n.push({type:"align",direction:a})}return"PRE"!=e.tagName&&"CODE"!=e.tagName||n.some((e=>"font"==e.type))||n.push({type:"font",family:"monospace"}),n}compareStyling(e,t){for(const n in e)if(e[n]!=t[n])return!1;return!0}elementHasStyle(e,t){const n=this.getStylingOfElement(e);return!(!n.some((e=>"foreColor"==e.type))||"foreColor"!=t.type||null!=t.color)||!(!n.some((e=>"backColor"==e.type))||"backColor"!=t.type||null!=t.color)||!(!n.some((e=>"size"==e.type))||"size"!=t.type||null!=t.size)||!(!n.some((e=>"link"==e.type))||"link"!=t.type)||!(!n.some((e=>"header"==e.type))||"header"!=t.type||null!=t.level)||!(!n.some((e=>"align"==e.type))||"align"!=t.type||null!=t.direction)||n.some((e=>this.compareStyling(e,t)))}detectStyling(e){var t=[];const n=this.getTextNodesInRange(e).nodes;var i=!0,o=0;for(const e of n)if(e.nodeType!=Node.TEXT_NODE||""!=e.textContent){o+=1;for(var s=e.parentNode,r=[];this.inEditor(s)&&s!=this.editor;)r.push(...this.getStylingOfElement(s)),s=s.parentNode;if(r.some((e=>"font"==e.type))||r.push({type:"font",family:this.defaultFont}),r.some((e=>"size"==e.type))||r.push({type:"size",size:this.defaultSize}),i)t.push(...r),i=!1;else{for(const e of t.slice(0,t.length))r.some((t=>this.compareStyling(t,e)))||this.requireSingleNodeToActivateStylingCommands.includes(e.type)||t.splice(t.findIndex((t=>t.type==e.type)),1);for(const e of r)this.requireSingleNodeToActivateStylingCommands.includes(e.type)&&(t.some((t=>this.compareStyling(t,e)))||t.push(e))}}return 0!=o||t.some((e=>"font"==e.type))||t.push({type:"font",family:this.defaultFont}),t}applyStyleToNode(e,t){for(var n=e;this.inEditor(n)&&n!=this.editor;){if(n.nodeType==Node.ELEMENT_NODE&&this.elementHasStyle(n,t))return n;n=n.parentNode}const i=this.styleToElement(t),o=document.createTextNode("");return e.after(o),i.appendChild(e),o.replaceWith(i),i}isAtEndOfParentNode(e,t){for(var n=e;t.contains(n)&&t!=n;){if(n.nextSibling)return!1;n=n.parentNode}return!0}applyStyle(e,t){var n,i,o;if(this.currentCursor){const e=document.createTextNode("");this.currentCursor.after(e),n=[e],i=0,o=0,this.currentCursor.remove(),this.currentCursor=null}else{const e=this.getTextNodesInRange(t);if(!e)return;({nodes:n,startOffset:i,endOffset:o}=e)}if(n.length>=2){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const t=n[0],a=n.slice(-1)[0];if(this.contentTags.includes(t.tagName))s=this.applyStyleToNode(t,e);else{var s=document.createTextNode(t.textContent.slice(i,t.textContent.length));t.textContent=t.textContent.slice(0,i),t.after(s),s=this.applyStyleToNode(s,e),""==t.textContent&&t.remove()}if(this.contentTags.includes(a.tagName))r=this.applyStyleToNode(a,e);else{var r=document.createTextNode(a.textContent.slice(0,o));a.textContent=a.textContent.slice(o,a.textContent.length),a.before(r),r=this.applyStyleToNode(r,e),""==a.textContent&&a.remove()}for(const t of n.slice(1,n.length-1))this.applyStyleToNode(t,e);const d=new Range;d.setStartBefore(s),d.setEndAfter(r),window.getSelection().removeAllRanges(),window.getSelection().addRange(d)}else if(1==n.length){if(this.cannotCreateCursorCommands.includes(e.type)&&""==t.toString())return window.getSelection().removeAllRanges(),void window.getSelection().addRange(t);this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const s=n[0];if(this.contentTags.includes(s.tagName)){if("BR"!=s.tagName&&i==o){const t=document.createTextNode("");0==i?s.before(t):s.after(t),this.applyStyleToNode(t,e);const n=this.createCursor();t.after(n),t.remove();const o=new Range;return o.selectNodeContents(n),o.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(o)}{const t=this.applyStyleToNode(s,e),n=new Range;return n.selectNode(t),this.blockTags.includes(s.tagName)&&n.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(n)}}var a=document.createTextNode(s.textContent.slice(i,o)),d=document.createTextNode(s.textContent.slice(o,s.textContent.length));s.textContent=s.textContent.slice(0,i),s.after(a,d),a=this.applyStyleToNode(a,e),""==s.textContent&&s.remove(),""==d.textContent&&d.remove();for(var l=s.parentElement,c=null,h=[];this.inEditor(l)&&this.editor!=l;){if("A"==l.tagName){c=l;break}h.push(l.cloneNode(!1)),l=l.parentElement}if(c&&this.isAtEndOfParentNode(a,c)){l=a;for(const e of h)e.append(l),l=e;c.after(l)}if(""==a.textContent){const e=this.createCursor();a.appendChild(e);const t=new Range;return t.selectNodeContents(e),t.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(t)}const r=new Range;r.selectNodeContents(a),window.getSelection().removeAllRanges(),window.getSelection().addRange(r)}else if(0==n.length){if(!this.inEditor(t.commonAncestorContainer))return;if(this.cannotCreateCursorCommands.includes(e.type))return;this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const n=document.createTextNode(""),i=t.commonAncestorContainer.childNodes;0==i.length?t.commonAncestorContainer.append(n):i[t.startOffset].after(n);const o=this.applyStyleToNode(n,e),s=this.createCursor();o.appendChild(s);const r=new Range;r.selectNodeContents(s),r.collapse(),window.getSelection().removeAllRanges(),window.getSelection().addRange(r)}}isEmpty(e){for(var t=e;e.contains(t)&&null!=t;){if(t.nodeType==Node.ELEMENT_NODE&&this.contentTags.includes(t.tagName))return!1;if(t.nodeType==Node.TEXT_NODE&&""!=t.textContent.replace(this.invisibleParsed,""))return!1;if(0!=t.childNodes.length)t=t.firstChild;else if(t.nextSibling)t=t.nextSibling;else{for(;!t.nextSibling&&e.contains(t)&&e!=t;)t=t.parentNode;t=t.nextSibling}}return!0}isEmptyOrLineBreak(e){var t=e,n=0;const i=this.contentTags.filter((e=>"BR"!=e));for(;e.contains(t)&&t!=this.editor;){if(t.nodeType==Node.ELEMENT_NODE&&i.includes(t.tagName))return!1;if(t.nodeType==Node.TEXT_NODE&&""!=t.textContent.replace(this.invisibleParsed,""))return!1;if("BR"==t.tagName){if(1==n)return!1;n=1}if(0!=t.childNodes.length)t=t.firstChild;else if(t.nextSibling)t=t.nextSibling;else{for(;!t.nextSibling&&e.contains(t)&&e!=t;)t=t.parentNode;t=t.nextSibling}}return!0}splitNodeAtChild(e,t,n=!1){for(var i=t,o=null;e.contains(i)&&e!=i;){const e=i.parentNode,t=Array.from(i.parentNode.childNodes);if(n&&null==o)var s=t.slice(t.indexOf(i)+0,t.length);else s=t.slice(t.indexOf(i)+1,t.length);if(null==o)(o=i.parentNode.cloneNode(!1)).append(...s);else{const e=o;(o=i.parentNode.cloneNode(!1)).append(e,...s)}i=e}return o}removeStyleFromElement(e,t){if(this.blockStylingCommands.includes(t.type)){switch(t.type){case"align":if(e.style.textAlign&&(e.style.textAlign.toLowerCase().includes(t.direction)||null==t.direction)){const t=document.createElement("div");t.append(...e.childNodes),t.setAttribute("style",e.getAttribute("style")?e.getAttribute("style"):""),t.style.textAlign="",e.remove(),e=t,i=!0}break;case"quote":if("BLOCKQUOTE"==e.tagName){const t=document.createElement("div");t.append(...e.childNodes),t.setAttribute("style",e.getAttribute("style")?e.getAttribute("style"):""),e.remove(),e=t,i=!0}break;case"header":if(e.tagName==t.level||null==t.level){const t=document.createElement("div");t.append(...e.childNodes),t.setAttribute("style",e.getAttribute("style")?e.getAttribute("style"):""),e.remove(),e=t,i=!0}break;case"list":if(e.tagName==("ordered"==t.listType?"OL":"UL")){const t=document.createElement("div");for(const n of Array.from(e.childNodes))if(Array.from(n.childNodes).every((e=>this.blockTags.includes(e.tagName)))||e.getAttribute("style"))t.append(...n.childNodes),n.remove();else{const i=document.createElement("div");i.append(...n.childNodes),i.setAttribute("style",e.getAttribute("style")?e.getAttribute("style"):""),n.remove(),t.append(i)}e.remove(),e=t,i=!0}}return e}if(e.getAttribute("style")){switch(t.type){case"bold":"bold"!=e.style.fontWeight.toLowerCase()&&"700"!=e.style.fontWeight||(e.style.fontWeight="");break;case"italic":"italic"==e.style.fontStyle.toLowerCase()&&(e.style.fontStyle="");break;case"underline":e.style.textDecoration.toLowerCase().includes("underline")&&(e.style.textDecoration=e.style.textDecoration.toLowerCase().replace("underline",""));break;case"strikethrough":e.style.textDecoration.toLowerCase().includes("line-through")&&(e.style.textDecoration=e.style.textDecoration.toLowerCase().replace("line-through",""));break;case"font":e.style.fontFamily&&(e.style.fontFamily="");break;case"size":e.style.fontSize&&(e.style.fontSize="");break;case"foreColor":e.style.color&&(e.style.color="");break;case"backColor":e.style.backgroundColor&&(e.style.backgroundColor="")}if(!e.getAttribute("style")&&!this.stylingTags.includes(e.tagName))return e.firstChild}const n=e.getAttribute("style");var i=!1;switch(t.type){case"bold":"B"!=e.tagName&&"STRONG"!=e.tagName||(e=e.firstChild,i=!0);break;case"italic":"I"!=e.tagName&&"EM"!=e.tagName||(e=e.firstChild,i=!0);break;case"underline":"U"==e.tagName&&(e=e.firstChild,i=!0);break;case"strikethrough":"S"==e.tagName&&(e=e.firstChild,i=!0);break;case"font":"FONT"==e.tagName&&e.hasAttribute("face")&&e.removeAttribute("face");break;case"size":"FONT"==e.tagName&&e.hasAttribute("size")&&e.removeAttribute("size");break;case"foreColor":"FONT"==e.tagName&&e.hasAttribute("color")&&e.removeAttribute("color");break;case"sup":"SUP"==e.tagName&&(e=e.firstChild,i=!0);break;case"sub":"SUB"==e.tagName&&(e=e.firstChild,i=!0);break;case"link":"A"==e.tagName&&(e=e.firstChild,i=!0)}if(n&&i){const t=document.createElement("span");t.setAttribute("style",n),t.append(e),e=t}return e}removeStyleOnNode(e,t){if(e.nodeType==Node.ELEMENT_NODE&&this.elementHasStyle(e,t)){const n=document.createTextNode("");e.after(n);const i=this.removeStyleFromElement(e,t);return n.after(i),n.remove(),i!=e&&e.remove(),i}const n=document.createTextNode("");e.after(n);var i=n,o=e;const s=e;e=n;for(var r=!1;this.inEditor(i)&&i!=this.editor&&i.parentNode!=this.editor;){var a=(i=i.parentNode).cloneNode(!1);if(a.appendChild(o),o=a,i.nodeType==Node.ELEMENT_NODE&&this.elementHasStyle(i,t)){r=!0;break}}if(!r)return n.after(s),n.remove(),s;o=this.removeStyleFromElement(o,t);const d=i,l=this.splitNodeAtChild(d,e);return this.isEmpty(l)||d.after(l),d.after(o),e.remove(),this.isEmpty(d)&&d.remove(),n.remove(),o}removeStyle(e,t){var n,i,o;if(this.currentCursor){const e=document.createTextNode("");this.currentCursor.after(e),n=[e],i=0,o=0,this.currentCursor.remove(),this.currentCursor=null}else{const e=this.getTextNodesInRange(t);if(!e)return;({nodes:n,startOffset:i,endOffset:o}=e)}if(n.length>=2){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const t=n[0],a=n.slice(-1)[0];if(this.contentTags.includes(t.tagName))s=t;else{var s=document.createTextNode(t.textContent.slice(i,t.textContent.length));t.textContent=t.textContent.slice(0,i),t.after(s),""==t.textContent&&t.remove()}if(this.contentTags.includes(a.tagName))r=a;else{var r=document.createTextNode(a.textContent.slice(0,o));a.textContent=a.textContent.slice(o,a.textContent.length),a.before(r),""==a.textContent&&a.remove()}r=this.removeStyleOnNode(r,e);for(const t of n.slice(1,n.length-1).reverse())this.removeStyleOnNode(t,e);s=this.removeStyleOnNode(s,e);const d=new Range;d.setStartBefore(s),d.setEndAfter(r),window.getSelection().removeAllRanges(),window.getSelection().addRange(d)}else if(1==n.length){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const t=n[0];if(this.contentTags.includes(t.tagName)){if("BR"!=t.tagName&&i==o){const n=document.createTextNode("");0==i?t.before(n):t.after(n),this.removeStyleOnNode(n,e);const o=this.createCursor();n.after(o),n.remove();const s=new Range;return s.selectNodeContents(o),s.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(s)}{const n=this.removeStyleOnNode(t,e),i=new Range;return i.selectNode(n),this.blockTags.includes(t.tagName)&&i.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(i)}}var a=document.createTextNode(t.textContent.slice(i,o)),d=document.createTextNode(t.textContent.slice(o,t.textContent.length));if(t.textContent=t.textContent.slice(0,i),t.after(a,d),a=this.removeStyleOnNode(a,e),""==t.textContent&&t.remove(),""==d.textContent&&d.remove(),""==a.textContent){const e=this.createCursor();for(var l=a;l.childNodes&&0!=l.childNodes.length;)l=l.childNodes[0];l.nodeType==Node.TEXT_NODE?l.after(e):l.append(e);const t=new Range;return t.selectNodeContents(e),t.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(t)}const s=new Range;s.selectNodeContents(a),window.getSelection().removeAllRanges(),window.getSelection().addRange(s)}else if(0==n.length){if(!this.inEditor(t.commonAncestorContainer))return;this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const n=document.createTextNode(""),i=t.commonAncestorContainer.childNodes;0==i.length?t.commonAncestorContainer.append(n):i[t.startOffset].after(n);const o=this.removeStyleOnNode(n,e),s=this.createCursor();for(l=o;l.childNodes&&0!=l.childNodes.length;)l=l.childNodes[0];l.nodeType==Node.TEXT_NODE?l.after(s):l.append(s);const r=new Range;r.selectNodeContents(s),r.collapse(),window.getSelection().removeAllRanges(),window.getSelection().addRange(r)}}changeStyleOnNode(e,t){var n=e,i=e.cloneNode(!0);for(n=n.parentNode;this.inEditor(n)&&n!=this.editor&&n!=this.editor;){var o=n.cloneNode(!1);if(o.appendChild(i),i=o,n.nodeType==Node.ELEMENT_NODE&&this.getStylingOfElement(n).some((e=>e.type==t.type))&&n!=this.editor){const o=this.splitNodeAtChild(n,e);switch(this.isEmpty(o)||n.after(o),n.after(i),e.remove(),this.isEmpty(n)&&n.remove(),t.type){case"font":"FONT"==i.tagName?i.setAttribute("face",t.family):i.style.fontFamily=t.family;break;case"size":"FONT"==i.tagName?(i.hasAttribute("size")&&i.removeAttribute("size"),i.style.fontSize=String(t.size)+"px"):i.style.fontSize=String(t.size)+"px";break;case"foreColor":"FONT"==i.tagName?i.setAttribute("color",t.color):i.style.color=t.color;break;case"backColor":i.style.backgroundColor=t.color;break;case"link":i.setAttribute("href",t.url)}return i}n=n.parentNode}const s=this.styleToElement(t);return s.appendChild(e.cloneNode(!0)),e.replaceWith(s),s}changeStyling(e,t){var n,i,o;if(this.currentCursor){const e=document.createTextNode("");this.currentCursor.after(e),n=[e],i=0,o=0,this.currentCursor.remove(),this.currentCursor=null}else{const e=this.getTextNodesInRange(t);if(!e)return;({nodes:n,startOffset:i,endOffset:o}=e)}if(n.length>=2){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const t=n[0],a=n.slice(-1)[0];if(this.contentTags.includes(t.tagName))s=t;else{var s=document.createTextNode(t.textContent.slice(i,t.textContent.length));t.textContent=t.textContent.slice(0,i),t.after(s),""==t.textContent&&t.remove()}if(this.contentTags.includes(a.tagName))r=a;else{var r=document.createTextNode(a.textContent.slice(0,o));a.textContent=a.textContent.slice(o,a.textContent.length),a.before(r),""==a.textContent&&a.remove()}r=this.changeStyleOnNode(r,e);for(const t of n.slice(1,n.length-1).reverse())this.changeStyleOnNode(t,e);s=this.changeStyleOnNode(s,e);const d=new Range;d.setStartBefore(s),d.setEndAfter(r),window.getSelection().removeAllRanges(),window.getSelection().addRange(d)}else if(1==n.length){if(this.cannotCreateCursorCommands.includes(e.type)&&""==t.toString())return window.getSelection().removeAllRanges(),void window.getSelection().addRange(t);this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const s=n[0];if(this.contentTags.includes(s.tagName)){if("BR"!=s.tagName&&i==o){const t=document.createTextNode("");0==i?s.before(t):s.after(t),this.changeStyleOnNode(t,e);const n=this.createCursor();t.after(n),t.remove();const o=new Range;return o.selectNodeContents(n),o.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(o)}{const t=this.changeStyleOnNode(s,e),n=new Range;return n.selectNode(t),this.blockTags.includes(s.tagName)&&n.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(n)}}var a=document.createTextNode(s.textContent.slice(i,o)),d=document.createTextNode(s.textContent.slice(o,s.textContent.length));if(s.textContent=s.textContent.slice(0,i),s.after(a,d),a=this.changeStyleOnNode(a,e),""==s.textContent&&s.remove(),""==d.textContent&&d.remove(),""==a.textContent){const e=this.createCursor();for(var l=a;l.childNodes&&0!=l.childNodes.length;)l=l.childNodes[0];l.nodeType==Node.TEXT_NODE?l.after(e):l.append(e);const t=new Range;return t.selectNodeContents(e),t.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(t)}const r=new Range;r.selectNodeContents(a),window.getSelection().removeAllRanges(),window.getSelection().addRange(r)}else if(0==n.length){if(!this.inEditor(t.commonAncestorContainer))return;if(this.cannotCreateCursorCommands.includes(e.type))return;this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const n=document.createTextNode(""),i=t.commonAncestorContainer.childNodes;0==i.length?t.commonAncestorContainer.append(n):i[t.startOffset].after(n);const o=this.changeStyleOnNode(n,e),s=this.createCursor();for(l=o;l.childNodes&&0!=l.childNodes.length;)l=l.childNodes[0];l.nodeType==Node.TEXT_NODE?l.after(s):l.append(s);const r=new Range;r.selectNodeContents(s),r.collapse(),window.getSelection().removeAllRanges(),window.getSelection().addRange(r)}}removeAllStylesOnNode(e,t){if(e.nodeType==Node.ELEMENT_NODE&&(this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName)){const t=e.querySelectorAll((this.inlineStylingTags+["SPAN"]).filter((e=>"A"!=e)).join(", "));(this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName)&&t.push(e);for(const e of t)e.after(...e.childNodes),chileElem.remove();return e}for(var n=null,i=e,o=null;this.inEditor(i)&&i!=this.editor&&(i=i.parentNode).nodeType==Node.ELEMENT_NODE&&(this.inlineStylingTags.includes(i.tagName)||"SPAN"==i.tagName);)n=i,"A"==i.tagName&&(o=i.cloneNode(!1));if(!n)return e;const s=this.splitNodeAtChild(n,e);return this.isEmpty(s)||n.after(s),n.after(e),this.isEmpty(n)&&n.remove(),o&&(e.after(o),o.append(e),e=o),e}removeAllStyles(e,t){var n,i,o;if(this.currentCursor){const e=document.createTextNode("");this.currentCursor.after(e),n=[e],i=0,o=0,this.currentCursor.remove(),this.currentCursor=null}else{const e=this.getTextNodesInRange(t);if(!e)return;({nodes:n,startOffset:i,endOffset:o}=e)}if(n.length>=2){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const t=n[0],a=n.slice(-1)[0];if(this.contentTags.includes(t.tagName))s=t;else{var s=document.createTextNode(t.textContent.slice(i,t.textContent.length));t.textContent=t.textContent.slice(0,i),t.after(s),""==t.textContent&&t.remove()}if(this.contentTags.includes(a.tagName))r=a;else{var r=document.createTextNode(a.textContent.slice(0,o));a.textContent=a.textContent.slice(o,a.textContent.length),a.before(r),""==a.textContent&&a.remove()}r=this.removeAllStylesOnNode(r,e);for(const t of n.slice(1,n.length-1).reverse())this.removeAllStylesOnNode(t,e);s=this.removeAllStylesOnNode(s,e);const d=new Range;d.setStartBefore(s),d.setEndAfter(r),window.getSelection().removeAllRanges(),window.getSelection().addRange(d)}else if(1==n.length){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const t=n[0];if(this.contentTags.includes(t.tagName)){if("BR"!=t.tagName&&i==o){const n=document.createTextNode("");0==i?t.before(n):t.after(n),this.removeAllStylesOnNode(n,e);const o=this.createCursor();n.after(o),n.remove();const s=new Range;return s.selectNode(o),s.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(s)}{const n=this.removeAllStylesOnNode(t,e),i=new Range;return i.selectNodeContents(n),this.blockTags.includes(t.tagName)&&i.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(i)}}var a=document.createTextNode(t.textContent.slice(i,o)),d=document.createTextNode(t.textContent.slice(o,t.textContent.length));if(t.textContent=t.textContent.slice(0,i),t.after(a,d),a=this.removeAllStylesOnNode(a,e),""==t.textContent&&t.remove(),""==d.textContent&&d.remove(),""==a.textContent){const e=this.createCursor();for(var l=a;l.childNodes&&0!=l.childNodes.length;)l=l.childNodes[0];l.nodeType==Node.TEXT_NODE?l.after(e):l.append(e);const t=new Range;return t.selectNodeContents(e),t.collapse(),window.getSelection().removeAllRanges(),void window.getSelection().addRange(t)}const s=new Range;s.selectNodeContents(a),window.getSelection().removeAllRanges(),window.getSelection().addRange(s)}else if(0==n.length){if(!this.inEditor(t.commonAncestorContainer))return;this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;const n=document.createTextNode(""),i=t.commonAncestorContainer.childNodes;0==i.length?t.commonAncestorContainer.append(n):i[t.startOffset].after(n);const o=this.removeAllStylesOnNode(n,e),s=this.createCursor();for(l=o;l.childNodes&&0!=l.childNodes.length;)l=l.childNodes[0];l.nodeType==Node.TEXT_NODE?l.after(s):l.append(s);const r=new Range;r.selectNodeContents(s),r.collapse(),window.getSelection().removeAllRanges(),window.getSelection().addRange(r)}}isValidBlockNode(e){return!!e&&e.nodeType==Node.ELEMENT_NODE&&!(!this.blockTags.includes(e.tagName)||"BR"==e.tagName)}isValidBlockStartPoint(e,t){return!!(e==this.editor&&0==t||this.isValidBlockNode(e.childNodes[t-1]))&&0!=(e.nodeType==Node.TEXT_NODE?e.textContent.length:e.childNodes.length)}isValidBlockEndPoint(e,t){for(var n=e.childNodes[t]?.previousSibling;n&&this.isEmpty(n);)n=n.previousSibling;return!!(e==this.editor&&t==this.editor.childNodes.length||this.isValidBlockNode(e.childNodes[t])||n&&this.isValidBlockNode(n)||this.isValidBlockNode(e)&&t==e.childNodes.length)&&0!=(e.nodeType==Node.TEXT_NODE?e.textContent.length:e.childNodes.length)}firstChildlessChild(e){for(;e.firstChild;)e=e.firstChild;return e}blockExtendRange(e,t=!0){for(var n=e.startContainer,i=e.startOffset,o=e.endContainer,s=e.endOffset;o[s]&&this.isEmpty(o[s]);)o==n&&s==i&&(i-=1),s-=1;if(!(0!=s||o==this.editor||s==i&&o==n||this.childlessTags.includes(o.tagName)||this.firstChildlessChild(o)&&"BR"==this.firstChildlessChild(o).tagName))for(;0==s&&o!=this.editor;)for(s=Array.from(o.parentNode.childNodes).indexOf(o),o=o.parentNode;o[s]&&this.isEmpty(o[s]);)o==n&&s==i&&(i-=1),s-=1;for(n.nodeType==Node.ELEMENT_NODE&&i==n.childNodes.length&&0!=i&&(i-=1);!this.isValidBlockStartPoint(n,i)&&(0==i?(i=Array.from(n.parentNode.childNodes).indexOf(n),n=n.parentNode):i-=1,!this.isValidBlockEndPoint(n,i)););if(t)for(;0==i&&n!=this.editor;)i=Array.from(n.parentNode.childNodes).indexOf(n),n=n.parentNode;else for(;0==i&&n!=this.editor&&["DIV","P"].includes(n.tagName);)i=Array.from(n.parentNode.childNodes).indexOf(n),n=n.parentNode;for(o.nodeType==Node.ELEMENT_NODE&&0==s&&0!=o.childNodes.length&&(s+=1);!this.isValidBlockEndPoint(o,s)&&(s==(o.nodeType==Node.TEXT_NODE?o.textContent.length:o.childNodes.length)?(s=Array.from(o.parentNode.childNodes).indexOf(o)+1,o=o.parentNode):s+=1,!this.isValidBlockStartPoint(o,s)););if(t)for(;s==(o.nodeType==Node.TEXT_NODE?o.textContent.length:o.childNodes.length)&&o!=this.editor;)s=Array.from(o.parentNode.childNodes).indexOf(o)+1,o=o.parentNode;else for(;s==(o.nodeType==Node.TEXT_NODE?o.textContent.length:o.childNodes.length)&&o!=this.editor&&["DIV","P"].includes(o.tagName);)s=Array.from(o.parentNode.childNodes).indexOf(o)+1,o=o.parentNode;const r=new Range;return r.setStart(n,i),r.setEnd(o,s),r}getBlockNodesInRange(e){const t=[];if(e.startContainer.nodeType!=Node.ELEMENT_NODE)var n=e.startContainer;else if(0==e.startContainer.length)n=e.startContainer;else{if(e.startContainer==this.editor&&e.startOffset==this.editor.childNodes.length)return;if(e.startOffset==e.startContainer.childNodes.length){for(var i=e.startContainer,o=e.startOffset;o==i.childNodes.length;)if(o=Array.from(i.parentNode.childNodes).indexOf(i),(i=i.parentNode)==this.editor&&e.startOffset==this.editor.childNodes.length)return;n=i.childNodes[o]}else n=e.startContainer.childNodes[e.startOffset]}if(n.nodeType!=Node.ELEMENT_NODE||e.isPointInRange(n,n.childNodes.length)||this.childlessTags.includes(n.tagName)){if(n.nodeType==Node.TEXT_NODE&&!e.intersectsNode(n)&&!this.childlessTags.includes(n.tagName))return t}else{if(0==n.childNodes.length||!e.intersectsNode(n))return t;for(;n.nodeType==Node.ELEMENT_NODE&&!e.isPointInRange(n,n.childNodes.length);)if(0==(n=n.firstChild).childNodes.length&&!e.intersectsNode(n))return t}for(t.push(n);this.inEditor(n);){if(n.nextSibling)n=n.nextSibling;else{for(;!n.nextSibling;)n=n.parentNode;if(n==this.editor||!this.inEditor(n))return t;n=n.nextSibling}if(n.nodeType!=Node.ELEMENT_NODE||e.isPointInRange(n,n.childNodes.length)){if(n.nodeType==Node.TEXT_NODE&&!e.intersectsNode(n))return t}else{if(0==n.childNodes.length||!e.intersectsNode(n))return t;for(;n.nodeType==Node.ELEMENT_NODE&&!e.isPointInRange(n,n.childNodes.length);)if(0==(n=n.firstChild).childNodes.length&&!e.intersectsNode(n))return t}t.push(n)}return t}adjustStartAndEndPoints(e,t,n,i){var o=!0;for(n.childNodes&&n.childNodes[i]&&this.childlessTags.includes(this.firstChildlessChild(n.childNodes[i]).tagName)&&(n=this.firstChildlessChild(n.childNodes[i]),i=0,o=!1);n[i]&&this.isEmpty(n[i])&&o;)n==e&&i==t&&(t-=1),i-=1;if(o&&0==i&&n!=this.editor&&(i!=t||n!=e)&&!this.childlessTags.includes(n.tagName)&&(!this.firstChildlessChild(n)||"BR"!=this.firstChildlessChild(n).tagName))for(;0==i&&n!=this.editor;)for(i=Array.from(n.parentNode.childNodes).indexOf(n),n=n.parentNode;n[i]&&this.isEmpty(n[i]);)n==e&&i==t&&(t-=1),i-=1;for(;e.nodeType==Node.ELEMENT_NODE&&!this.childlessTags.includes(e.tagName)&&!this.inlineStylingTags.includes(e.tagName)&&"SPAN"!=e.tagName&&0!=e.childNodes.length;)t==e.childNodes.length?t=(e=e.childNodes[t-1]).nodeType==Node.ELEMENT_NODE?e.childNodes.length:e.textContent.length:(e=e.childNodes[t],t=0);for(;o&&n.nodeType==Node.ELEMENT_NODE&&!this.childlessTags.includes(n.tagName)&&!this.inlineStylingTags.includes(n.tagName)&&"SPAN"!=n.tagName&&0!=n.childNodes.length;)if(0==i)if(this.childlessTags.includes(n.childNodes[0].tagName)&&"BR"!=n.childNodes[0].tagName){const e=document.createTextNode("");n.prepend(e),n=e,i=0}else n=n.childNodes[i],i=0;else n.childNodes[i-1].compareDocumentPosition(e)==Node.DOCUMENT_POSITION_FOLLOWING&&n.childNodes[i]?(n=n.childNodes[i],i=0):i=(n=n.childNodes[i-1]).nodeType==Node.ELEMENT_NODE?n.childNodes.length:n.textContent.length;return[e,t,n,i]}applyBlockStyleToNode(e,t,n=null,i=!1){for(var o=e;this.inEditor(o)&&o!=this.editor;){if(o.nodeType==Node.ELEMENT_NODE&&this.elementHasStyle(o,t))return o;o=o.parentNode}const s=n?this.findLastParent(e,n):null;if(s&&s!=e){const t=this.splitNodeAtChild(s,e,!0),n=this.splitNodeAtChild(t,e,!1);s.after(t,n),s!=this.editor&&this.isEmpty(s)&&s.remove(),n!=this.editor&&this.isEmpty(n)&&n.remove(),e=t}if(i)for(;e.nodeType==Node.ELEMENT_NODE&&1==e.childNodes.length&&this.blockTags.includes(e.childNodes[0].tagName)&&!this.childlessTags.includes(e.childNodes[0].tagName);)e=e.childNodes[0];const r=this.styleToElement(t);if("LI"==e.tagName)return 0==r.childNodes.length?r.append(...e.childNodes):r.childNodes[0].append(...e.childNodes),e.append(r),r;if(i)"OL"==e.tagName||"UL"==e.tagName?0!=e.childNodes.length&&(r.appendChild(...e.childNodes[0].childNodes),e.childNodes[0].append(r)):(0==r.childNodes.length?r.append(...e.childNodes):r.childNodes[0].append(...e.childNodes),e.append(r));else{const t=document.createTextNode("");e.after(t),0==r.childNodes.length?r.appendChild(e):r.childNodes[0].appendChild(e),t.replaceWith(r)}return r}removeExtraneousParents(e){const t=[];function n(e){if(e!=this.editor)if(["DIV","P"].includes(e.tagName)&&Array.from(e.childNodes).some((e=>this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName)))&&!e.getAttribute("style")){const n=Array.from(e.childNodes),i=[];for(;n.length>0;){const e=n.shift();if(this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName))i.push(e);else{const t=document.createElement("div");for(t.append(e);n[0]&&!this.blockTags.includes(n[0].tagName);){const e=n.shift();t.append(e)}i.push(t)}}t.push(...i),e.after(...i),e.remove()}else t.push(e);else t.push(e)}return n=n.bind(this),e.forEach(n),t}removeExtraneousParentsRecursively(e){const t=document.createTextNode("");function n(e){if(e.firstChild)if(["DIV","P"].includes(e.tagName)&&Array.from(e.childNodes).some((e=>this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName)))&&!e.getAttribute("style")){const t=Array.from(e.childNodes),i=[];for(;t.length>0;){const e=t.shift();if(this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName))i.push(e);else{const n=document.createElement("div");for(n.append(e);t[0]&&!this.blockTags.includes(t[0].tagName);){const e=t.shift();n.append(e)}i.push(n)}}e.after(...i),e.remove();for(const e of i)e.nodeType==Node.ELEMENT_NODE&&(e.querySelector("div:not([style]), p:not([style])")||e.matches("div:not([style]), p:not([style])"))&&n(e)}else for(const t of Array.from(e.childNodes))t.nodeType==Node.ELEMENT_NODE&&(t.querySelector("div:not([style]), p:not([style])")||t.matches("div:not([style]), p:not([style])"))&&n(t)}e.after(t),e.remove(),n=n.bind(this),Array.from(e.childNodes).forEach(n),t.replaceWith(e)}applyBlockStyle(e,t){this.shouldTakeSnapshotOnNextChange=!0,""==this.editor.innerHTML&&(this.editor.append(document.createElement("br")),t=this.getRange());var n=t.startContainer,i=t.startOffset,o=t.endContainer,s=t.endOffset,r=this.imageModule.getSelected();this.imageModule.deselect();const a=!this.inlineBlockStylingCommands.includes(e.type),d=this.blockExtendRange(t);[n,i,o,s]=this.adjustStartAndEndPoints(n,i,o,s);const l=this.getBlockNodesInRange(d);if(t.endContainer.childNodes&&t.endContainer.childNodes[t.endOffset]&&this.childlessTags.includes(this.firstChildlessChild(t.endContainer.childNodes[t.endOffset]).tagName)){const e=this.firstChildlessChild(t.endContainer.childNodes[t.endOffset]);l.includes(e)||l[l.length-1]&&l[l.length-1].contains(e)||l.push(e)}const c=this.removeExtraneousParents(l),h=[];if("header"==e.type)var u="blockquote, ul, ol, li, h1, h2, h3, h4, h5, h6, div, p";else u=this.inlineBlockStylingCommands.includes(e.type)?"blockquote, ul, ol, li, div, p":null;function m(e){if(e.nodeType==Node.ELEMENT_NODE&&(e==this.editor||u&&(e.matches(u)||e.querySelector(u))))for(const t of e.childNodes)m(t);else h.push(e)}m=m.bind(this);for(const e of c)m(e);if("header"==e.type)for(const e of h){if(e.nodeType!=Node.ELEMENT_NODE)continue;const t=Array.from(e.querySelectorAll("span, font"));e.matches("span, font")&&t.push(e);for(const e of t)e.style.fontSize&&(e.style.fontSize=""),e.getAttribute("size")&&e.removeAttribute("size")}if("quote"==e.type||"list"==e.type)var p=e=>this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName||["H1","H2","H3","H4","H5","H6"].includes(e.tagName)||e.style&&(e.style.textAlign||e.style.marginLeft);else p=this.inlineBlockStylingCommands.includes(e.type)?e=>this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName||["H1","H2","H3","H4","H5","H6"].includes(e.tagName):e=>this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName;var g=null,f=null,N=null,b=null;for(const n of h){const i=n.nextSibling;if(this.isEmpty(n)&&(!this.currentCursor||!n.contains(this.currentCursor))){b=i,n.remove();continue}if(!n.contains(t.commonAncestorContainer)||n==t.commonAncestorContainer||!this.blockTags.includes(n.tagName)||this.childlessTags.includes(n.tagName)||this.inlineBlockStylingCommands.includes(e.type)||n.getAttribute("style")||["H1","H2","H3","H4","H5","H6"].includes(n.tagName))y=!1;else var y=!0;const o=this.applyBlockStyleToNode(n,e,p,y);this.removeExtraneousParents([o.parentNode]),g||(g=o),f&&f.nextSibling==o&&b==n?!a&&this.blockTags.filter((e=>"BR"!=e)).includes(n.tagName)?f=o:"list"!=e.type||this.blockTags.includes(n.tagName)||this.blockTags.includes(N.tagName)||"BR"==this.firstChildlessChild(n).tagName?this.inlineBlockStylingCommands.includes(e.type)&&this.blockTags.filter((e=>"BR"!=e)).includes(n.tagName)?f=o:(f.append(...o.childNodes),o.remove()):(f.lastChild.append(...o.firstChild.childNodes),o.remove()):f=o,y&&["DIV","P"].includes(n.tagName)&&!n.getAttribute("style")?(n.after(...n.childNodes),n.remove(),N=n.childNodes[0]):N=n,b=i}if(this.removeExtraneousParentsRecursively(this.editor),"list"==e.type){if(g){const e=this.leftSiblingIgnoreEmpty(g);e&&e.tagName==g.tagName&&(e.append(...g.childNodes),g.remove(),f==g&&(f=e),g=e)}if(f){const e=this.rightSiblingIgnoreEmpty(f);e&&e.tagName==f.tagName&&(e.prepend(...f.childNodes),f.remove(),f=e)}}if(r)return void this.imageModule.select(r);const v=new Range;v.setStart(n,i),v.setEnd(o,s),document.getSelection().removeAllRanges(),document.getSelection().addRange(v)}removeBlockStyleOnNode(e,t,n=!0){const i=document.createNodeIterator(e,NodeFilter.SHOW_ELEMENT,(e=>this.elementHasStyle(e,t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT));var o;const s=[];for(;o=i.nextNode();)o!=this.editor&&s.push(o);var r=null;const a=[];for(const n of s){const i=document.createTextNode("");n.after(i);const o=this.removeStyleFromElement(n,t);this.inEditor(e)||r||(r=o),Array.from(o.childNodes).every((e=>this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName)))&&a.push(o),i.after(o),i.remove(),Array.from(o.parentNode.childNodes).every((e=>this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName)))&&!o.parentNode.getAttribute("style")&&o.parentNode!=this.editor&&"DIV"==o.parentNode.tagName&&a.push(o.parentNode)}for(var d=[],l=e=r||e;this.inEditor(l)&&l!=this.editor;)this.elementHasStyle(l,t)&&d.push(l),l=l.parentNode;for(const i of d){if(0==n&&r)break;const o=this.splitNodeAtChild(i,e,!0),s=this.splitNodeAtChild(o,e),d=document.createTextNode("");i.after(d);var c=this.removeStyleFromElement(o,t);this.inEditor(e)||r||(r=c),Array.from(c.childNodes).every((e=>this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName)))&&a.push(c),d.after(c,s),d.remove(),Array.from(c.parentNode.childNodes).every((e=>this.blockTags.filter((e=>"BR"!=e)).includes(e.tagName)))&&!c.parentNode.getAttribute("style")&&c.parentNode!=this.editor&&"DIV"==c.parentNode.tagName&&a.push(c.parentNode),i!=this.editor&&this.isEmpty(i)&&i.remove(),i.lastChild&&this.isEmpty(i.lastChild)&&i.lastChild.remove(),s!=this.editor&&this.isEmpty(s)&&s.remove(),s.firstChild&&this.isEmpty(s.firstChild)&&s.firstChild.remove(),e=c}for(const e of a)r==e&&(r=1!=e.childNodes.length?Array.from(e.childNodes):e.firstChild),e.after(...e.childNodes),e.remove();return r}removeBlockStyle(e,t,n=!0){if(this.shouldTakeSnapshotOnNextChange=!0,""==this.editor.innerHTML)return;var i=t.startContainer,o=t.startOffset,s=t.endContainer,r=t.endOffset,a=this.imageModule.getSelected();this.imageModule.deselect();const d=this.blockExtendRange(t);[i,o,s,r]=this.adjustStartAndEndPoints(i,o,s,r);const l=this.getBlockNodesInRange(d);if(t.endContainer.childNodes&&t.endContainer.childNodes[t.endOffset]&&this.childlessTags.includes(this.firstChildlessChild(t.endContainer.childNodes[t.endOffset]).tagName)){const e=this.firstChildlessChild(t.endContainer.childNodes[t.endOffset]);l.includes(e)||l[l.length-1]&&l[l.length-1].contains(e)||l.push(e)}const c=this.removeExtraneousParents(l);var h=null,u=null;for(const t of c){const i=h&&u&&h==t&&!this.blockTags.filter((e=>"BR"!=e)).includes(t.tagName);h=t.nextSibling;const o=this.removeBlockStyleOnNode(t,e,n);!i||!o||o instanceof Array?u=o instanceof Array?null:o:(u.append(...o.childNodes),o.remove())}if(a)return void this.imageModule.select(a);const m=new Range;m.setStart(i,o),m.setEnd(s,r),document.getSelection().removeAllRanges(),document.getSelection().addRange(m)}replaceListsOnNode(e,t,n){const i=document.createNodeIterator(e,NodeFilter.SHOW_ELEMENT,(e=>e.tagName==t?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT));var o;const s=[];for(;o=i.nextNode();)o!=this.editor&&s.push(o);var r=!1,a=null;for(const t of s){const i=document.createTextNode("");t.after(i);const o=document.createElement(n);o.append(...t.childNodes),t.remove(),this.inEditor(e)||a||(a=o,r=!0),i.after(o),i.remove()}if(!r){const t=this.findClosestParent(e,(e=>"OL"==e.tagName||"UL"==e.tagName));if(t){e=t;const i=document.createTextNode("");e.after(i);const o=document.createElement(n);o.append(...e.childNodes),e.remove(),i.after(o),i.remove()}}}replaceListStyle(e,t,n){if(this.shouldTakeSnapshotOnNextChange=!0,""==this.editor.innerHTML)return;var i=n.startContainer,o=n.startOffset,s=n.endContainer,r=n.endOffset,a=this.imageModule.getSelected();this.imageModule.deselect();const d=this.blockExtendRange(n);[i,o,s,r]=this.adjustStartAndEndPoints(i,o,s,r);const l=this.getBlockNodesInRange(d);if(n.endContainer.childNodes&&n.endContainer.childNodes[n.endOffset]&&this.childlessTags.includes(this.firstChildlessChild(n.endContainer.childNodes[n.endOffset]).tagName)){const e=this.firstChildlessChild(n.endContainer.childNodes[n.endOffset]);l.includes(e)||l[l.length-1]&&l[l.length-1].contains(e)||l.push(e)}e="ordered"==e?"OL":"UL",t="ordered"==t?"OL":"UL";for(const n of l)this.replaceListsOnNode(n,e,t);if(a)return void this.imageModule.select(a);const c=new Range;c.setStart(i,o),c.setEnd(s,r),document.getSelection().removeAllRanges(),document.getSelection().addRange(c)}joinAdjacentNestedListsLeft(e){if(!e)return e;const t=this.leftSiblingIgnoreEmpty(e);if(t&&["OL","UL"].includes(e.tagName)&&t.tagName==e.tagName)return t.append(...e.childNodes),e.remove(),t;if(!t&&["OL","UL"].includes(e.tagName)&&"LI"==e.parentNode.tagName&&this.leftSiblingIgnoreEmpty(e.parentNode)&&0!=this.leftSiblingIgnoreEmpty(e.parentNode).childNodes.length&&this.leftSiblingIgnoreEmpty(e.parentNode).childNodes[this.leftSiblingIgnoreEmpty(e.parentNode).childNodes.length-1].tagName==e.tagName){const t=this.leftSiblingIgnoreEmpty(e.parentNode),n=t.childNodes[t.childNodes.length-1];t.childNodes[t.childNodes.length-1].append(...e.childNodes);const i=e.parentNode;return e.remove(),0==i.childNodes.length&&i.remove(),n}return e}joinAdjacentNestedListsRight(e){if(!e)return e;const t=this.rightSiblingIgnoreEmpty(e);if(t&&["OL","UL"].includes(e.tagName)&&t.tagName==e.tagName)return t.prepend(...e.childNodes),e.remove(),t;if(!t&&["OL","UL"].includes(e.tagName)&&"LI"==e.parentNode.tagName&&this.rightSiblingIgnoreEmpty(e.parentNode)&&0!=this.rightSiblingIgnoreEmpty(e.parentNode).childNodes.length&&this.rightSiblingIgnoreEmpty(e.parentNode).childNodes[0].tagName==e.tagName){this.rightSiblingIgnoreEmpty(e.parentNode).childNodes[0].prepend(...e.childNodes);const t=e.parentNode;e.remove(),0==t.childNodes.length&&t.remove()}}updateHideNestedLists(e){const t=e.querySelectorAll("li");for(const e of t)e.firstChild&&["OL","UL"].includes(e.firstChild.tagName)?e.style.listStyleType="none":"none"==e.style.listStyleType.toLowerCase()&&(e.style.listStyleType="");for(var n=e;this.inEditor(n)&&n!=this.editor;)"LI"==n.tagName&&n.firstChild&&["OL","UL"].includes(n.firstChild.tagName)?n.style.listStyleType="none":"LI"==n.tagName&&"none"==n.style.listStyleType.toLowerCase()&&(n.style.listStyleType=""),n=n.parentNode}blockIndentSiblingNodes(e){const t=this.findClosestParent(e[0],(e=>e.nodeType==Node.ELEMENT_NODE&&(["OL","UL"].includes(e.tagName)||e.style&&"40px"==e.style.marginLeft.toLowerCase())));var n=null,i=null;if("LI"==e[0].tagName){const o=document.createElement("li");e[0].before(o);const s=t.cloneNode(!1);if(s.append(...e),o.append(s),i||(i=s),n=s,"LI"==s.parentNode.tagName&&s.parentNode.previousSibling){const e=s.parentNode;e.previousSibling.append(...e.childNodes),e.remove()}}else{const o=t?t.cloneNode(!1):document.createElement("div");if("DIV"==o.tagName){o.style.marginLeft="40px";const t=document.createTextNode("");e[0].before(t);const n=[];for(;0!=e.length;){const t=e[0];if(this.blockTags.includes(t.tagName)){const i=o.cloneNode(!1);i.append(t),n.push(i),e.shift()}else{const i=o.cloneNode(!1);for(i.append(t),e.shift();0!=e.length&&!this.blockTags.includes(e[0].tagName);)i.append(e.shift());n.push(i)}}t.before(...n),t.remove()}else if(["OL","UL"].includes(o.tagName)){e[0].before(o);const t=[];for(;0!=e.length;){const n=e[0];if(this.blockTags.includes(n.tagName)){const i=document.createElement("li");i.append(n),t.push(i),e.shift()}else{const i=document.createElement("li");for(i.append(n),e.shift();0!=e.length&&!this.blockTags.includes(e[0].tagName);)i.append(e.shift());t.push(i)}}if(o.append(...t),i||(i=o),n=o,"LI"==o.parentNode.tagName&&o.parentNode.previousSibling){const e=o.parentNode;e.previousSibling.append(...e.childNodes),e.remove()}}}const o=i==n,s=this.joinAdjacentNestedListsLeft(i);return o&&(n=s),n&&this.updateHideNestedLists(n),n}blockIndent(e){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0,""==this.editor.innerHTML&&(this.editor.append(document.createElement("br")),e=this.getRange());var t=e.startContainer,n=e.startOffset,i=e.endContainer,o=e.endOffset,s=this.imageModule.getSelected();this.imageModule.deselect();const r=this.blockExtendRange(e);[t,n,i,o]=this.adjustStartAndEndPoints(t,n,i,o);var a=this.getBlockNodesInRange(r);if(e.endContainer.childNodes&&e.endContainer.childNodes[e.endOffset]&&this.childlessTags.includes(this.firstChildlessChild(e.endContainer.childNodes[e.endOffset]).tagName)){const t=this.firstChildlessChild(e.endContainer.childNodes[e.endOffset]);a.includes(t)||a[a.length-1]&&a[a.length-1].contains(t)||a.push(t)}const d=this.removeExtraneousParents(a),l=[];function c(e){if(e.nodeType==Node.ELEMENT_NODE&&(e==this.editor||!["OL","UL"].includes(e.tagName)&&e.querySelector("blockquote, ul, ol, li, div, p")))for(const t of e.childNodes)c(t);else l.push(e)}c=c.bind(this);for(const e of d)c(e);a=l.reverse();for(var h=null;0!=a.length;){const e=[a.pop()];for(;0!=a.length&&e[e.length-1].nextSibling==a[a.length-1];)e.push(a.pop());h=this.blockIndentSiblingNodes(e)}if(this.joinAdjacentNestedListsRight(h),s)return void this.imageModule.select(s);const u=new Range;u.setStart(t,n),u.setEnd(i,o),document.getSelection().removeAllRanges(),document.getSelection().addRange(u)}blockOutdentSiblingNodes(e){for(const t of e){const e=this.findClosestParent(t,(e=>["OL","UL"].includes(e.tagName)||e.style&&"40px"==e.style.marginLeft.toLowerCase()));if(e)if(["OL","UL"].includes(e.tagName)){if(e==t){const t=Array.from(e.childNodes),n=[];for(const e of t){const t=Array.from(e.childNodes);if(t.every((e=>this.blockTags.includes(e.tagName))))n.push(...t);else{const e=document.createElement("div");e.append(...t),n.push(e)}}e.after(...n);const i=e.parentNode;if(e.remove(),this.updateHideNestedLists(i),"LI"==n[0].parentNode.tagName){const e=n[0].parentNode,t=Array.from(e.childNodes).slice(Array.from(e.childNodes).indexOf(n[n.length-1])+1,e.childNodes.length),i=document.createElement("li");i.append(...t),e.after(i),this.isEmpty(i)&&i.remove();const o=[];for(;0!=n.length;){const t=n[0];if(this.blockTags.includes(t.tagName)){const e=document.createElement("li");e.append(t),o.push(e),n.shift()}else{const e=document.createElement("li");for(e.append(t),n.shift();0!=n.length&&!this.blockTags.includes(n[0].tagName);)e.append(n.shift());o.push(e)}e.after(...o)}o.forEach((e=>this.updateHideNestedLists(e))),this.updateHideNestedLists(e),this.isEmpty(e)&&e.remove()}continue}const n=this.splitNodeAtChild(e,t,!0),i=this.splitNodeAtChild(n,t,!1),o=Array.from(n.childNodes),s=[];for(const e of o){const t=Array.from(e.childNodes);if(t.every((e=>this.blockTags.includes(e.tagName))))s.push(...t);else{const e=document.createElement("div");e.append(...t),s.push(e)}}if(e.after(...s,i),n.remove(),this.isEmpty(e)&&e.remove(),this.isEmpty(i)&&i.remove(),0==s.length)continue;if("LI"==s[0].parentNode.tagName){const e=s[0].parentNode,t=Array.from(e.childNodes).slice(Array.from(e.childNodes).indexOf(s[s.length-1])+1,e.childNodes.length),n=document.createElement("li");n.append(...t),e.after(n),this.isEmpty(n)&&n.remove();const i=[];for(;0!=s.length;){const t=s[0];if(this.blockTags.includes(t.tagName)){const e=document.createElement("li");e.append(t),i.push(e),s.shift()}else{const e=document.createElement("li");for(e.append(t),s.shift();0!=s.length&&!this.blockTags.includes(s[0].tagName);)e.append(s.shift());i.push(e)}e.after(...i)}this.updateHideNestedLists(n),i.forEach((e=>this.updateHideNestedLists(e))),this.updateHideNestedLists(e),this.isEmpty(e)&&e.remove()}this.updateHideNestedLists(e)}else if(e.nodeType==Node.ELEMENT_NODE&&"40px"==e.style.marginLeft.toLowerCase()){if(e==t){e.style.marginLeft="";const t=Array.from(e.childNodes);t.every((e=>this.blockTags.includes(e.tagName)))&&["DIV","P"].includes(e.tagName)&&!e.getAttribute("style")&&(e.after(...t),e.remove());continue}const n=this.splitNodeAtChild(e,t,!0),i=this.splitNodeAtChild(n,t,!1);n.style.marginLeft="";const o=Array.from(n.childNodes);o.every((e=>this.blockTags.includes(e.tagName)))&&["DIV","P"].includes(e.tagName)&&!e.getAttribute("style")?e.after(...o,i):e.after(n,i),this.isEmpty(e)&&e.remove(),this.isEmpty(i)&&i.remove()}}}blockOutdent(e){if(""==this.editor.innerHTML)return;this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0;var t=e.startContainer,n=e.startOffset,i=e.endContainer,o=e.endOffset,s=this.imageModule.getSelected();this.imageModule.deselect();const r=this.blockExtendRange(e);[t,n,i,o]=this.adjustStartAndEndPoints(t,n,i,o);var a=this.getBlockNodesInRange(r);if(e.endContainer.childNodes&&e.endContainer.childNodes[e.endOffset]&&this.childlessTags.includes(this.firstChildlessChild(e.endContainer.childNodes[e.endOffset]).tagName)){const t=this.firstChildlessChild(e.endContainer.childNodes[e.endOffset]);a.includes(t)||a[a.length-1]&&a[a.length-1].contains(t)||a.push(t)}const d=this.removeExtraneousParents(a),l=[];function c(e){if(e.nodeType==Node.ELEMENT_NODE&&(e==this.editor||e.querySelector("ol, ul")||e.querySelector('[style*="margin-left: 40px"]')))for(const t of e.childNodes)c(t);else l.push(e)}c=c.bind(this);for(const e of d)c(e);for(a=l.reverse();0!=a.length;){const e=[a.pop()];for(;0!=a.length&&e[e.length-1].nextSibling==a[a.length-1];)e.push(a.pop());this.blockOutdentSiblingNodes(e)}if(s)return void this.imageModule.select(s);const h=new Range;h.setStart(t,n),h.setEnd(i,o),document.getSelection().removeAllRanges(),document.getSelection().addRange(h)}onNodeDrawn(e,t){ResizeObserver&&new ResizeObserver(function(e,n){0!=e[0].contentRect.height&&(t(),n.disconnect())}.bind(this)).observe(e)}inlineInsertImage(e,t){this.saveHistory(),t.deleteContents(),this.imageModule.getSelected()&&this.imageModule.deselect(),this.removeCursor(!1);const n=document.createElement("img");if(n.setAttribute("src",e.url),e.alt&&n.setAttribute("alt",e.alt),n.style.width=this.defaultImageWidth,this.childlessTags.includes(t.commonAncestorContainer))return t.commonAncestorContainer.after(n),t.commonAncestorContainer.remove(),document.getSelection().removeAllRanges(),void this.onNodeDrawn(n,function(){this.imageModule.select(n)}.bind(this));if(this.isEmptyOrLineBreak(t.commonAncestorContainer)){const e=t.commonAncestorContainer.querySelector("br");if(e)return e.replaceWith(n),void this.onNodeDrawn(n,function(){this.imageModule.select(n)}.bind(this))}t.insertNode(n),document.getSelection().removeAllRanges(),this.onNodeDrawn(n,function(){this.imageModule.select(n)}.bind(this))}blockInsertHR(e,t){var n;if(this.saveHistory(),t.deleteContents(),this.imageModule.getSelected()&&this.imageModule.deselect(),this.removeCursor(!1),t.startContainer.nodeType==Node.TEXT_NODE){n=t.startContainer;const e=document.createTextNode(n.textContent.slice(t.startOffset,n.textContent.length));n.textContent=n.textContent.slice(0,t.startOffset),n.after(e)}else this.childlessTags.includes(t.startContainer)?n=t.startContainer:0==t.startOffset?(n=document.createTextNode(""),t.startContainer.prepend(n)):n=t.startContainer.childNodes[t.startOffset-1];const i=document.createElement("hr"),o=this.findLastParent(n,(e=>["H1","H2","H3","H4","H5","H6"].includes(e.tagName)||e.style&&e.style.textAlign||this.inlineStylingTags.includes(e.tagName)||"SPAN"==e.tagName));if(o){const e=this.splitNodeAtChild(o,n);o.after(i,e)}else n.after(i);const s=new Range;s.selectNode(i),s.collapse(!1),document.getSelection().removeAllRanges(),document.getSelection().addRange(s)}performStyleCommand(e){const t=this.getRange();if(null==t)return;const n=this.detectStyling(t);if("remove"==e.type)this.removeAllStyles(e,t);else if(this.multipleValueStylingCommands.includes(e.type)&&this.inlineStylingCommands.includes(e.type))("foreColor"==e.type||"backColor"==e.type)&&null==e.color||"link"==e.type&&null==e.url?this.removeStyle(e,t):this.changeStyling(e,t);else if(this.inlineStylingCommands.includes(e.type))if(n.some((t=>t.type==e.type)))this.removeStyle(e,t);else if("sup"==e.type||"sub"==e.type){const n="sub"==e.type?"sup":"sub";this.removeStyle({type:n},t),this.applyStyle(e,this.getRange())}else this.applyStyle(e,t);else if(this.blockStylingCommands.includes(e.type))switch(e.type){case"quote":this.saveHistory(),n.some((t=>t.type==e.type))?this.removeBlockStyle(e,t):this.applyBlockStyle(e,t);break;case"header":this.saveHistory(),this.removeBlockStyle({type:"header",level:null},t);var i=this.getRange();"Paragraph"!=e.level&&this.applyBlockStyle(e,i);break;case"align":this.saveHistory(),this.removeBlockStyle({type:"align",direction:null},t),i=this.getRange(),this.applyBlockStyle(e,i);break;case"list":if(this.saveHistory(),"ordered"==e.listType){const i=n.find((e=>"list"==e.type&&"ordered"==e.listType)),o=n.find((e=>"list"==e.type&&"unordered"==e.listType));i?this.removeBlockStyle(i,t):o?this.replaceListStyle("unordered","ordered",t):this.applyBlockStyle(e,t)}else if("unordered"==e.listType){const i=n.find((e=>"list"==e.type&&"unordered"==e.listType)),o=n.find((e=>"list"==e.type&&"ordered"==e.listType));i?this.removeBlockStyle(i,t):o?this.replaceListStyle("ordered","unordered",t):this.applyBlockStyle(e,t)}break;case"indent":this.blockIndent(t);break;case"outdent":this.blockOutdent(t)}else if(this.insertCommands.includes(e.type))switch(e.type){case"insertImage":this.inlineInsertImage(e,t);break;case"insertHorizontalRule":this.blockInsertHR(e,t)}this.onChangeSelect()}bold(){this.performStyleCommand({type:"bold"})}italic(){this.performStyleCommand({type:"italic"})}underline(){this.performStyleCommand({type:"underline"})}strikethrough(){this.performStyleCommand({type:"strikethrough"})}font(){this.performStyleCommand({type:"font",family:this.menubarOptions.font.getValue()})}foreColor(e){this.performStyleCommand({type:"foreColor",color:e}),null!=e&&(this.iconDirectory?this.menubarOptions.foreColor.colorInput.getElementsByClassName("editor-menubar-option-fore-color-button")[0].childNodes[0].style.borderBottom="2px solid "+e:this.menubarOptions.foreColor.colorInput.getElementsByClassName("editor-menubar-option-fore-color-button")[0].style.textDecorationColor=e)}backColor(e){this.performStyleCommand({type:"backColor",color:e}),null!=e&&(this.iconDirectory?this.menubarOptions.backColor.colorInput.getElementsByClassName("editor-menubar-option-back-color-button")[0].childNodes[0].style.borderBottom="2px solid "+e:this.menubarOptions.backColor.colorInput.getElementsByClassName("editor-menubar-option-back-color-button")[0].style.textDecorationColor=e)}sup(){this.performStyleCommand({type:"sup"})}sub(){this.performStyleCommand({type:"sub"})}size(){this.performStyleCommand({type:"size",size:this.menubarOptions.size.value})}link(e){e&&"javascript:"==e.trim().substring(0,11).toLowerCase()&&(e="about:blank#blocked"),this.performStyleCommand({type:"link",url:e})}quote(){this.performStyleCommand({type:"quote"})}header(){this.performStyleCommand({type:"header",level:this.menubarOptions.header.getValue()})}align(){this.performStyleCommand({type:"align",direction:this.menubarOptions.align.getValue()})}listOrdered(){this.performStyleCommand({type:"list",listType:"ordered"})}listUnordered(){this.performStyleCommand({type:"list",listType:"unordered"})}indent(){this.performStyleCommand({type:"indent"})}outdent(){this.performStyleCommand({type:"outdent"})}insertImage(e,t){this.performStyleCommand({type:"insertImage",url:e,alt:t})}insertHR(){this.performStyleCommand({type:"insertHorizontalRule"})}remove(){this.performStyleCommand({type:"remove"})}openFindAndReplace(){this.findAndReplaceModule.open()}async serializeContents(e){function t(e){return new Promise(((t,n)=>{const i=new FileReader;i.onload=e=>t(i.result),i.onerror=e=>n(i.error),i.onabort=e=>n(new Error("Failed to read blob")),i.readAsDataURL(e)}))}const n=[];for(const o of e.childNodes)if(!this.isEmpty(o))if(o.nodeType==Node.TEXT_NODE)n.push(o.textContent);else if(o.nodeType==Node.ELEMENT_NODE){const e={};for(var i=0;i<o.attributes.length;i++)if("src"==o.attributes[i].name.toLowerCase()&&"IMG"==o.tagName&&o.attributes[i].value.toLowerCase().startsWith("blob")){const n=await(await fetch(o.attributes[i].value)).blob(),s=await t(n);e.src=s}else e[o.attributes[i].name]=o.attributes[i].value;n.push({tag:o.tagName,children:this.serializeContents(o),attrs:e})}return n}deserializeContents(e,t){for(const a of e)if("string"==typeof a||a instanceof String)t.append(document.createTextNode(a));else{const e=document.createElement(a.tag);for(const t in a.attrs)if("img"==a.tag.toLowerCase()&&"src"==t.toLowerCase()&&a.attrs[t].toLowerCase().startsWith("data")){for(var n=a.attrs[t].split(",")[0].split(":")[1].split(";")[0],i=atob(a.attrs[t].split(",")[1]),o=[],s=0;s<i.length;s++)o.push(i.charCodeAt(s));const d=new Blob([new Uint8Array(o)],{type:n});var r=URL.createObjectURL(d);e.setAttribute("src",r),this.imageObjectURLs.push(r)}else e.setAttribute(t,a.attrs[t]);this.deserializeContents(a.children,e),t.append(e)}}serializeRange(e){function t(e){var t=e;const n=[];for(;this.inEditor(t)&&t!=this.editor;)n.push(Array.from(t.parentNode.childNodes).indexOf(t)),t=t.parentNode;return n}const n=(t=t.bind(this))(e.startContainer),i=t(e.endContainer);return{startContainer:n,startOffset:e.startOffset,endContainer:i,endOffset:e.endOffset}}deserializeRange(e){const t=new Range;function n(e){for(var t=this.editor;0!=e.length;)t=t.childNodes[e[e.length-1]],e.pop();return t}const i=(n=n.bind(this))(e.startContainer),o=n(e.endContainer);return t.setStart(i,e.startOffset),t.setEnd(o,e.endOffset),t}snapshot(){const e=this.editor.cloneNode(!0);var t=null;const n=this.getRange();return n&&n&&this.inEditor(n.commonAncestorContainer)&&(t=this.serializeRange(n,this.editor)),{content:e,range:t,hash:this.hash(this.editor.innerHTML)}}saveHistory(){this.hash(this.editor.innerHTML)==this.history[this.history.length-1]?.hash&&this.history.pop(),this.history.length>=this.historyLimit&&this.history.shift();const e=this.snapshot();this.history.push(e)}undo(){var e=this.history.pop();if(e.hash==this.hash(this.editor.innerHTML)&&0!=this.history.length&&(e=this.history.pop()),this.redoHistory.push(this.snapshot()),this.editor.innerHTML="",this.editor.append(...e.content.childNodes),null!=e.range){const t=this.deserializeRange(e.range,this.editor);window.getSelection().removeAllRanges(),window.getSelection().addRange(t)}0!=this.editor.getElementsByClassName("editor-temp-cursor").length&&(this.currentCursor=this.editor.getElementsByClassName("editor-temp-cursor")[0]),0==this.history.length&&this.saveHistory(),this.imageModule.deselect()}redo(){if(0!=this.redoHistory.length){var e=this.redoHistory.pop();if(this.saveHistory(),e.hash==this.hash(this.editor.innerHTML)&&(e=this.redoHistory.pop()),this.editor.innerHTML="",this.editor.append(...e.content.childNodes),null!=e.range){const t=this.deserializeRange(e.range,editor);window.getSelection().removeAllRanges(),window.getSelection().addRange(t)}0!=this.editor.getElementsByClassName("editor-temp-cursor").length&&(this.currentCursor=this.editor.getElementsByClassName("editor-temp-cursor")[0]),this.imageModule.deselect()}}new(){for(this.history=[],this.redoHistory=[],this.shouldTakeSnapshotOnNextChange=!1,this.rangeCache=null,this.editor.innerHTML="",this.saveHistory();0!=this.imageObjectURLs.length;){const e=this.imageObjectURLs.pop();URL.revokeObjectURL(e)}}init(){this.history=[],this.redoHistory=[],this.shouldTakeSnapshotOnNextChange=!1,this.imageObjectURLs=[],this.rangeCache=null,this.ignoreNextSelectEvent=!1,this.container.innerHTML="",this.container.setAttribute("role","application"),this.container.setAttribute("aria-label","Editor"),this.createMenubar(),this.editor=document.createElement("div"),this.editor.setAttribute("id","editor-body"),this.editor.setAttribute("contenteditable","true"),this.editor.setAttribute("spellcheck",!!this.spellcheck),this.editor.setAttribute("role","textbox"),this.editor.setAttribute("aria-label","Editor main editing area"),this.container.append(this.editor),this.saveHistory(),this.applySizeStyles(),this.applyDefaultFont(),this.applyDefaultSize(),this.bindKeyboardEvents(),this.bindInputEvents(),this.bindClickEvents(),this.bindSelectEvents(),this.bindPasteEvents(),this.bindDragEvents(),this.bindExternalClickEvents(),this.bindSaveHistoryInterval(),this.imageModule=this.MimirUI.bindImageEditing(this.editor,function(){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0}.bind(this)),this.findAndReplaceModule=this.MimirUI.findAndReplace(this.editor,function(){this.saveHistory(),this.shouldTakeSnapshotOnNextChange=!0}.bind(this),this)}}},176:e=>{const t={};t.isTouchInput="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,t.dropdown=(e,t)=>{const n=document.createElement("div");n.classList.add("editor-dropdown");const i=document.createElement("div");i.classList.add("editor-dropdown-button"),n.append(i),i.append(e);const o=document.createElement("div");function s(e){"Escape"==e.key&&l()}function r(t){o.contains(t.target)||(o.classList.contains("editor-dropdown-show")&&o.classList.remove("editor-dropdown-show"),i.setAttribute("aria-expanded","false"),o.setAttribute("aria-hidden","true"),o.setAttribute("aria-disabled","true"),e.contains(t.target)&&(a=!0),document.removeEventListener("mousedown",r),n.dispatchEvent(new Event("editorDropdownClose",{bubbles:!0})),i.addEventListener("click",d),document.removeEventListener("keydown",s))}o.classList.add("editor-dropdown-body"),n.append(o),o.append(t),o.setAttribute("role","dialog"),o.setAttribute("aria-hidden","true"),o.setAttribute("aria-disabled","true"),i.setAttribute("aria-haspopup","true"),i.setAttribute("aria-expanded","false"),i.addEventListener("mousedown",(function(e){e.preventDefault()}));var a=!1;function d(){if(a)return void(a=!1);i.removeEventListener("click",d),o.style.left="",o.classList.add("editor-dropdown-show"),i.setAttribute("aria-expanded","true"),o.setAttribute("aria-hidden","false"),o.setAttribute("aria-disabled","false"),document.addEventListener("mousedown",r),document.addEventListener("keydown",s),n.dispatchEvent(new Event("editorDropdownOpen",{bubbles:!0}));const e=o.getBoundingClientRect();e.right>window.innerWidth&&e.right-window.innerWidth>1&&(o.style.left=Math.max(-(e.right-window.innerWidth),-e.left).toString()+"px")}function l(){o.classList.contains("editor-dropdown-show")&&o.classList.remove("editor-dropdown-show"),i.setAttribute("aria-expanded","false"),o.setAttribute("aria-hidden","true"),o.setAttribute("aria-disabled","true"),document.removeEventListener("mousedown",r),n.dispatchEvent(new Event("editorDropdownClose",{bubbles:!0})),i.addEventListener("click",d),document.removeEventListener("keydown",s)}return i.addEventListener("click",d),{dropdown:n,body:t,button:i,close:l}},t.dropdownList=(e,n)=>{if(0==e.length)return null;const i=document.createElement("button");i.classList.add("editor-dropdown-list-open-button");var o=e[0].name;const s=[],r=document.createElement("div");for(const t of e){const e=t.content,i=t.name,o=document.createElement("button");o.append(e),s.push({name:i,button:o,content:e,buttonDisplay:t.buttonDisplay});const l=document.createElement("div");l.append(o),r.append(l),r.setAttribute("role","menuitem"),o.addEventListener("click",(e=>{d(i),n(i),a.close()}))}r.classList.add("editor-dropdown-list-options");const a=t.dropdown(i,r);function d(e){s.some((t=>t.name==e))||(e=s[0]?.name),o=e,l()}function l(){i.innerHTML="";const e=s.find((e=>e.name==o));e&&(e.buttonDisplay?i.append(e.buttonDisplay.cloneNode(!0)):i.append(e.content.cloneNode(!0)))}return a.dropdown.classList.add("editor-dropdown-list"),a.dropdown.setAttribute("role","listbox"),l(),{dropdown:a,getValue:function(){return o},setValue:d,list:a.dropdown}},t.numberInput=(e,t)=>{const n=document.createElement("input");n.setAttribute("type","number"),n.setAttribute("min",e),n.setAttribute("max",t),n.classList.add("editor-number-input-input");const i=document.createElement("button");i.innerHTML="+",i.addEventListener("click",(function(){n.value=Math.max(Math.min(parseFloat(n.value)+1,t),e),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))})),i.classList.add("editor-number-input-button");const o=document.createElement("button");o.innerHTML="-",o.addEventListener("click",(function(){n.value=Math.max(Math.min(parseFloat(n.value)-1,t),e),n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))})),o.classList.add("editor-number-input-button");const s=document.createElement("div");return s.append(o,n,i),s.classList.add("editor-number-input"),{numberInput:s,input:n,plus:i,minus:o}},t.rgbToHsv=(e,t,n)=>{e/=255,t/=255,n/=255;var i=Math.max(e,Math.max(t,n)),o=Math.min(e,Math.min(t,n)),s=i-o,r=-1;return i==o?r=0:i==e?r=((t-n)/s*60+360)%360:i==t?r=((n-e)/s*60+120)%360:i==n&&(r=((e-t)/s*60+240)%360),[r,0==i?0:s/i*100,100*i]},t.colorInput=(e,n,i,o,s)=>{const r=document.createElement("div");r.classList.add("editor-color-input-body");const a=document.createElement("div"),d=document.createElement("div");d.style.width=i+"px",d.style.height=s+"px",d.classList.add("editor-color-picker-primary-container");const l=document.createElement("canvas");l.setAttribute("width",i),l.setAttribute("height",s),l.classList.add("editor-color-picker-primary-canvas"),d.append(l);const c=document.createElement("div");c.classList.add("editor-color-picker-primary-thumb"),d.append(c),a.append(d);const h=document.createElement("div");h.style.width=o+"px",h.style.height=s+"px",h.classList.add("editor-color-picker-hue-container");const u=document.createElement("canvas");u.setAttribute("width",o),u.setAttribute("height",s),u.classList.add("editor-color-picker-hue-canvas"),h.append(u);const m=document.createElement("div");m.classList.add("editor-color-picker-hue-slider"),h.append(m),a.append(h);const p=document.createElement("div");p.classList.add("editor-color-picker-rgb-form");const g=document.createElement("div");function f(e){const n=document.createElement("div");n.classList.add("editor-color-picker-rgb-form-input-container");const o=document.createElement("label");o.append(e),o.classList.add("editor-color-picker-rgb-form-input-label");const r=document.createElement("input");return r.setAttribute("type","number"),r.setAttribute("min","0"),r.setAttribute("max","255"),r.addEventListener("change",(()=>{w=b.value,R=v.value,M=C.value,w=Math.min(Math.max(parseInt(w),0),255),R=Math.min(Math.max(parseInt(R),0),255),M=Math.min(Math.max(parseInt(M),0),255),b.value=w,v.value=R,C.value=M;var[e,n,o]=t.rgbToHsv(w,R,M);x=e,H=n/100*i,I=s-o/100*s,D.fillStyle=`hsl(${x}deg 100% 50%)`,D.fillRect(0,0,i,s);var r=D.createLinearGradient(0,0,i,0);r.addColorStop(0,"rgba(255, 255, 255, 1)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),D.fillStyle=r,D.fillRect(0,0,i,s);var a=D.createLinearGradient(0,0,0,s);a.addColorStop(0,"rgba(0, 0, 0, 0)"),a.addColorStop(1,"rgba(0, 0, 0, 1)"),D.fillStyle=a,D.fillRect(0,0,i,s),c.style.backgroundColor=`rgb(${w}, ${R}, ${M})`,c.style.transform=`translate(${H-5}px, ${I-5}px`,g.style.backgroundColor=`rgb(${w}, ${R}, ${M})`,m.style.transform=`translate(0, ${x/360*s}px`})),n.append(o,r),[n,r]}g.classList.add("editor-color-picker-rgb-form-color"),p.append(g);const[N,b]=f("R"),[y,v]=f("G"),[E,C]=f("B");p.append(N,y,E),a.append(p),r.append(a),a.classList.add("editor-color-picker-row");const T=document.createElement("div"),S=document.createElement("button");S.classList.add("editor-color-picker-save-button","editor-action-button-primary"),S.innerHTML="Save",S.addEventListener("click",(()=>{e(`rgb(${w}, ${R}, ${M})`),k()}));const O=document.createElement("button");O.classList.add("editor-color-picker-remove-button","editor-action-button-secondary"),O.innerHTML="Remove",O.addEventListener("click",(()=>{e(null),k()})),T.append(S,O),r.append(T),T.classList.add("editor-color-picker-row"),n.classList.add("editor-color-picker-button");const L=t.dropdown(n,r),A=L.dropdown,k=L.close;var x=0,w=255,R=0,M=0,H=0,I=0,D=l.getContext("2d",{willReadFrequently:!0}),B=u.getContext("2d"),P=!1,z=!1;function U(){D.fillStyle=`hsl(${x}deg 100% 50%)`,D.fillRect(0,0,i,s);var e=D.createLinearGradient(0,0,i,0);e.addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(1,"rgba(255, 255, 255, 0)"),D.fillStyle=e,D.fillRect(0,0,i,s);var t=D.createLinearGradient(0,0,0,s);t.addColorStop(0,"rgba(0, 0, 0, 0)"),t.addColorStop(1,"rgba(0, 0, 0, 1)"),D.fillStyle=t,D.fillRect(0,0,i,s),[w,R,M]=D.getImageData(H,I,1,1).data,c.style.backgroundColor=`rgb(${w}, ${R}, ${M})`,c.style.transform=`translate(${H-5}px, ${I-5}px`,g.style.backgroundColor=`rgb(${w}, ${R}, ${M})`,b.value=w,v.value=R,C.value=M}function F(e){if(e.touches){const t=l.getBoundingClientRect();H=Math.min(Math.max(e.touches[0].clientX-t.x,0),i-1),I=Math.max(Math.min(e.touches[0].clientY-t.y,s-1),0)}else{const t=l.getBoundingClientRect();H=Math.min(Math.max(e.clientX-t.x,0),i-1),I=Math.max(Math.min(e.clientY-t.y,s-1),0)}[w,R,M]=D.getImageData(H,I,1,1).data,c.style.backgroundColor=`rgb(${w}, ${R}, ${M})`,c.style.transform=`translate(${H-5}px, ${I-5}px`,g.style.backgroundColor=`rgb(${w}, ${R}, ${M})`,b.value=w,v.value=R,C.value=M}function _(e){P=!0,F(e),document.addEventListener("mouseup",V),document.addEventListener("touchend",V),document.addEventListener("mousemove",q,!1),document.addEventListener("mouseup",V,!1),document.addEventListener("touchmove",q,!1),document.addEventListener("touchend",V,!1)}function q(e){e.preventDefault(),P&&F(e)}function V(e){P=!1,document.removeEventListener("mouseup",V),document.removeEventListener("touchend",V),document.removeEventListener("mousemove",q),document.removeEventListener("mouseup",V),document.removeEventListener("touchmove",q),document.removeEventListener("touchend",V)}function X(e){if(e.touches){const t=u.getBoundingClientRect(),n=Math.max(Math.min(e.touches[0].clientY-t.y,s),0);x=n/s*360,m.style.transform=`translate(0, ${n}px`}else{const t=u.getBoundingClientRect(),n=Math.max(Math.min(e.clientY-t.y,s),0);x=n/s*360,m.style.transform=`translate(0, ${n}px`}U()}function $(e){z=!0,X(e),document.addEventListener("mouseup",K),document.addEventListener("touchend",K),document.addEventListener("mousemove",j,!1),document.addEventListener("mouseup",K,!1),document.addEventListener("touchmove",j,!1),document.addEventListener("touchend",K,!1)}function j(e){e.preventDefault(),z&&X(e)}function K(e){z=!1,document.removeEventListener("mouseup",K),document.removeEventListener("touchend",K),document.removeEventListener("mousemove",j),document.removeEventListener("mouseup",K),document.removeEventListener("touchmove",j),document.removeEventListener("touchend",K)}return A.addEventListener("editorDropdownOpen",(function(){U(),function(){B.rect(0,0,o,s);var e=B.createLinearGradient(0,0,0,s);e.addColorStop(0,"rgba(255, 0, 0, 1)"),e.addColorStop(.17,"rgba(255, 255, 0, 1)"),e.addColorStop(.34,"rgba(0, 255, 0, 1)"),e.addColorStop(.51,"rgba(0, 255, 255, 1)"),e.addColorStop(.68,"rgba(0, 0, 255, 1)"),e.addColorStop(.85,"rgba(255, 0, 255, 1)"),e.addColorStop(1,"rgba(255, 0, 0, 1)"),B.fillStyle=e,B.fill()}(),l.addEventListener("mousedown",_),l.addEventListener("touchstart",_),u.addEventListener("mousedown",$),u.addEventListener("touchstart",$)})),A.addEventListener("editorDropdownClose",(function(){l.removeEventListener("mousedown",_),l.removeEventListener("touchstart",_),u.removeEventListener("mousedown",$),u.removeEventListener("touchstart",$)})),{colorInput:A,dropdown:L,getValue:function(){return`rgb(${w}, ${R}, ${M})`}}},t.linkInput=(e,n)=>{const i=document.createElement("div");i.classList.add("editor-link-input-body");const o=document.createElement("h4");o.innerHTML="Insert Link",o.classList.add("editor-modal-label");const s=document.createElement("input");s.classList.add("editor-link-input-input","editor-modal-input"),s.setAttribute("placeholder","URL"),i.append(o,s),n.classList.add("editor-link-input-button");const r=t.dropdown(n,i),a=r.dropdown,d=r.close;var l=null;const c=document.createElement("button");c.classList.add("editor-link-input-save-button","editor-action-button-primary"),c.innerHTML="Save",c.addEventListener("click",(()=>{e(s.value),l=s.value,d(),s.value=""}));const h=document.createElement("button");h.classList.add("editor-link-input-remove-button","editor-action-button-secondary"),h.innerHTML="Remove",h.addEventListener("click",(()=>{e(null),d()}));const u=document.createElement("div");return u.classList.add("editor-modal-row"),u.append(c,h),i.append(u),{linkInput:a,dropdown:r,getValue:function(){return l}}},t.imageInput=(e,n,i)=>{const o=document.createElement("div");o.classList.add("editor-image-input-body");const s=document.createElement("h4");s.innerHTML="Insert Image",s.classList.add("editor-modal-label");const r=document.createElement("input");r.classList.add("editor-image-input-input"),r.setAttribute("type","file"),r.setAttribute("accept","image/jpeg, image/png, image/gif, image/bmp, image/webp, image/tiff");const a=document.createElement("input");a.classList.add("editor-image-url-input","editor-modal-input"),a.setAttribute("placeholder","URL");const d=document.createElement("input");d.classList.add("editor-image-alt-input","editor-modal-input"),d.setAttribute("placeholder","Alt Text"),o.append(s,r,a,d),n.classList.add("editor-image-input-button");const l=t.dropdown(n,o),c=l.dropdown,h=l.close,u=document.createElement("button");u.classList.add("editor-image-input-save-button"),u.innerHTML="Save",u.addEventListener("click",(()=>{if(0!=r.files.length){const t=URL.createObjectURL(r.files[0]);e(t,d.value?d.value:r.files[0].name),i.push(t)}else a.value&&e(a.value,d.value?d.value:a.value.split("/").pop());r.value=null,a.value="",h()})),u.classList.add("editor-action-button-primary");const m=document.createElement("div");return m.classList.add("editor-modal-row"),m.append(u),o.append(m),{imageInput:c,dropdown:l}},t.bindImageEditing=(e,t)=>{const n=document.createElement("div");n.setAttribute("id","editor-image-editing-ui"),e.after(n);const i=document.createElement("div"),o=document.createElement("div"),s=document.createElement("div"),r=document.createElement("div");i.classList.add("resize-bar","resize-bar-horizontal","resize-bar-top"),o.classList.add("resize-bar","resize-bar-horizontal","resize-bar-bottom"),s.classList.add("resize-bar","resize-bar-vertical","resize-bar-left"),r.classList.add("resize-bar","resize-bar-vertical","resize-bar-right"),n.append(i,o,s,r);const a=document.createElement("div"),d=document.createElement("div"),l=document.createElement("div"),c=document.createElement("div");a.classList.add("resize-box","resize-box-top-right"),d.classList.add("resize-box","resize-box-top-left"),l.classList.add("resize-box","resize-box-bottom-right"),c.classList.add("resize-box","resize-box-bottom-left"),a.setAttribute("unselectable","true"),d.setAttribute("unselectable","true"),l.setAttribute("unselectable","true"),c.setAttribute("unselectable","true"),n.append(a,d,l,c);var h,u,m=null,p=null,g=null,f=0,N=0;function b(e){m=e,a.style.display="block",d.style.display="block",l.style.display="block",c.style.display="block",i.style.display="block",o.style.display="block",s.style.display="block",r.style.display="block",v();const t=getComputedStyle(m),n=parseInt(t.width.slice(0,-2)),h=parseInt(t.height.slice(0,-2));u=n,N=h,window.addEventListener("resize",v),m.classList.add("editor-hide-selection"),document.getSelection().removeAllRanges()}function y(){m&&(m.classList.remove("editor-hide-selection"),m=null,a.style.display="none",d.style.display="none",l.style.display="none",c.style.display="none",i.style.display="none",o.style.display="none",s.style.display="none",r.style.display="none",window.removeEventListener("resize",v))}function v(){if(!m)return;const e=m.getBoundingClientRect(),t=document.documentElement.scrollTop;d.style.left=e.left-5+"px",d.style.top=e.top+t-5+"px",a.style.left=e.left+e.width-5+"px",a.style.top=e.top+t-5+"px",c.style.left=e.left-5+"px",c.style.top=e.bottom+t-5+"px",l.style.left=e.left+e.width-5+"px",l.style.top=e.bottom+t-5+"px",i.style.left=e.left+"px",i.style.top=e.top+t+"px",i.style.width=e.width+"px",o.style.left=e.left+"px",o.style.top=e.bottom+t+"px",o.style.width=e.width+"px",s.style.left=e.left+"px",s.style.top=e.top+t+"px",s.style.height=e.height+"px",r.style.left=e.left+e.width+"px",r.style.top=e.top+t+"px",r.style.height=e.height+"px"}function E(e){m&&(e.preventDefault(),e.touches&&(e=e.touches[0]),p=e.target,h=e.clientX,f=e.clientY)}function C(e){if(!m)return;if(!p)return;e.preventDefault(),e.touches&&(e=e.touches[0]);const t=e.clientX-h,n=e.clientY-f;h=e.clientX,f=e.clientY;const i=Math.sqrt(u*u+N*N),o=u/i,s=N/i;switch(p){case d:u-=t,N-=n;var r=Math.sqrt(u*u+N*N);u=o*r,N=s*r,m.style.width=u+"px",m.style.height=N+"px";break;case a:u+=t,N-=n,r=Math.sqrt(u*u+N*N),u=o*r,N=s*r,m.style.width=u+"px",m.style.height=N+"px";break;case c:u-=t,N+=n,r=Math.sqrt(u*u+N*N),u=o*r,N=s*r,m.style.width=u+"px",m.style.height=N+"px";break;case l:u+=t,N+=n,r=Math.sqrt(u*u+N*N),u=o*r,N=s*r,m.style.width=u+"px",m.style.height=N+"px"}v()}function T(e){m&&p&&(p=null,t())}function S(e){e.addEventListener("mousedown",E),e.addEventListener("touchstart",E)}function O(e){m&&(e.preventDefault(),e.touches&&(e=e.touches[0]),g=e.target,h=e.clientX,f=e.clientY)}function L(e){if(!m)return;if(!g)return;e.preventDefault(),e.touches&&(e=e.touches[0]);const t=e.clientX-h,n=e.clientY-f;switch(h=e.clientX,f=e.clientY,g){case s:u-=t,m.style.width=u+"px",m.style.height=N+"px";break;case r:u+=t,m.style.width=u+"px",m.style.height=N+"px";break;case i:case o:N+=n,m.style.width=u+"px",m.style.height=N+"px"}v()}function A(e){m&&g&&(g=null,t())}function k(e){e.addEventListener("mousedown",O),e.addEventListener("touchstart",O)}return S(a),S(d),S(l),S(c),document.addEventListener("mousemove",C),document.addEventListener("mouseup",T),document.addEventListener("touchmove",C),document.addEventListener("touchend",T),k(i),k(s),k(r),k(o),document.addEventListener("mousemove",L),document.addEventListener("mouseup",A),document.addEventListener("touchmove",L),document.addEventListener("touchend",A),e.addEventListener("mousedown",(e=>{e.target!=m&&(n.contains(e.target)||(e.target!=m&&m&&y(),"IMG"==e.target.tagName&&b(e.target)))})),window.addEventListener("mousedown",(t=>{e.parentNode&&e.parentNode.contains(t.target)||n.contains(t.target)||y()})),document.addEventListener("keydown",(e=>{m&&("Delete"!=e.key&&"Backspace"!=e.key||(m.remove(),y()))})),e.addEventListener("keydown",(e=>{if("c"==e.key&&(e.ctrlKey||e.metaKey)&&m&&0==document.getSelection().rangeCount){const e=new Range;e.selectNode(m),document.getSelection().removeAllRanges(),document.getSelection().addRange(e)}else if("x"==e.key&&(e.ctrlKey||e.metaKey)&&m&&0==document.getSelection().rangeCount){const e=new Range;e.selectNode(m),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),y()}else if("v"==e.key&&(e.ctrlKey||e.metaKey)&&m&&0==document.getSelection().rangeCount){const e=new Range;e.selectNode(m),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),m.remove(),y()}else if("ArrowLeft"==e.key&&m&&0==document.getSelection().rangeCount){const e=new Range;e.selectNode(m),e.collapse(!0),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),y()}else if("ArrowRight"==e.key&&m&&0==document.getSelection().rangeCount){const e=new Range;e.selectNode(m),e.collapse(!1),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),y()}else if("ArrowUp"==e.key&&m&&0==document.getSelection().rangeCount){const e=new Range;e.selectNode(m),e.collapse(!1),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),y()}else if("ArrowDown"==e.key&&m&&0==document.getSelection().rangeCount){const e=new Range;e.selectNode(m),e.collapse(!1),document.getSelection().removeAllRanges(),document.getSelection().addRange(e),y()}})),{getSelected:()=>m,select:e=>{b(e)},deselect:()=>{y()}}},t.findAndReplace=(e,t,n)=>{const i=document.createElement("div");i.setAttribute("id","editor-find-and-replace-ui"),i.setAttribute("aria-hidden","true"),i.setAttribute("aria-disabled","true"),e.before(i);const o=document.createElement("div");o.classList.add("editor-modal-row");const s=document.createElement("input");s.classList.add("editor-find-and-replace-find-input","editor-modal-input"),s.setAttribute("placeholder","Search for"),o.append(s);const r=document.createElement("button");r.classList.add("editor-find-and-replace-find-button","editor-action-button-primary"),r.innerHTML="Find",o.append(r);const a=document.createElement("button");a.classList.add("editor-find-and-replace-find-up-button","editor-action-button-secondary"),a.innerHTML="&#9650;",o.append(a);const d=document.createElement("button");d.classList.add("editor-find-and-replace-find-down-button","editor-action-button-secondary"),d.innerHTML="&#9660;",o.append(d);const l=document.createElement("button");l.classList.add("editor-find-and-replace-toggle-case-sensitive-button"),l.innerHTML="Aa",l.classList.toggle("editor-toggled",!0),o.append(l),i.append(o);const c=document.createElement("div");c.classList.add("editor-modal-row");const h=document.createElement("input");h.classList.add("editor-find-and-replace-replace-input","editor-modal-input"),h.setAttribute("placeholder","Replace with"),c.append(h);const u=document.createElement("button");u.classList.add("editor-find-and-replace-replace-button","editor-action-button-primary"),u.innerHTML="Replace",c.append(u);const m=document.createElement("button");m.classList.add("editor-find-and-replace-replace-all-button","editor-action-button-primary"),m.innerHTML="Replace All",c.append(m),i.append(c);var p=!1,g=null,f=null,N=null,b=!1,y=!0;function v(){const t=i.getBoundingClientRect(),n=e.getBoundingClientRect();i.style.left=n.right-t.width+"px"}function E(){p=!1,i.style.display="none",n.menubarOptions.openFindAndReplace.setAttribute("aria-expanded","false"),i.setAttribute("aria-expanded","false"),i.setAttribute("aria-hidden","true"),i.setAttribute("aria-disabled","true"),S()}function C(e){"Escape"==e.key&&E()}function T(e){i.contains(e.target)||("block"==i.style.display&&E(),document.removeEventListener("mousedown",T),document.removeEventListener("keydown",C),n.menubarOptions.openFindAndReplace&&n.menubarOptions.openFindAndReplace.contains(e.target)&&(b=!0))}function S(){f&&(R(g),g=null,f=null,N=null)}function O(){if(S(),""==s.value)return f=null,g=null,N=0,a.disabled=!0,d.disabled=!0,u.disabled=!0,void(m.disabled=!0);(g=L(s.value.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")))&&(g=x(g),f=s.value,g=w(g),N=0,g[N]?.forEach((e=>e.wrapper.classList.add("editor-find-and-replace-current"))),a.disabled=!1,d.disabled=!1,u.disabled=!1,m.disabled=!1,g[N]&&g[N][0].wrapper?.scrollIntoView(!1))}function L(t){const n=["BR","DIV","P","OL","UL","LI","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","HR"];if(!e.firstChild)return;var i=e.textContent.split(" ").join(" ");y||(i=i.toLowerCase(),t=t.toLowerCase());const o=i.matchAll(t),s=[];function r(t,i){var o=e.firstChild,s=0;const r=[];for(var a=!1;s<i;){if(a&&n.includes(o.tagName))return null;if(s+o.textContent.length>t)if(o.nodeType==Node.TEXT_NODE){const e=Math.max(t-s,0),n=Math.min(i-s,o.data.length);r.push({node:o,startOffset:e,endOffset:n}),a=!0}else if(o.firstChild){o=o.firstChild;continue}if(s+=o.textContent.length,o.nextSibling)o=o.nextSibling;else{for(;!o.nextSibling;)if((o=o.parentNode)==e)return r;o=o.nextSibling}}return r}for(const e of o){const t=r(e.index,e.index+e[0].length);null!=t&&s.push(t)}return s}function A(){const e=document.createElement("span");return e.classList.add("editor-find-and-replace-match"),e}function k(t){function i(t,i){for(var o=t;n.inEditor(o.parentNode)&&o.parentNode!=e&&n.isEmpty(o.parentNode)&&(n.inlineStylingTags.includes(o.parentNode.tagName)||"SPAN"==o.parentNode.tagName);)o=o.parentNode;if(i){const e=n.leftSiblingIgnoreEmpty(o),t=n.rightSiblingIgnoreEmpty(o);if(n.blockTags.includes(o.parentNode.tagName)&&n.isEmpty(o.parentNode)&&!n.childlessTags.includes(o.parentNode.tagName))o.before(document.createElement("BR"));else if(e&&n.blockTags.includes(e.tagName)&&(!t||n.blockTags.includes(t.tagName))||t&&n.blockTags.includes(t.tagName)&&(!e||n.blockTags.includes(e.tagName))){t&&"BR"==t.tagName&&t.remove(),e&&"BR"==e.tagName&&e.remove();const n=document.createElement("div");n.append(document.createElement("br")),o.before(n)}}return o.remove(),o}if(g[N]){const e=g[N];e[0].node.textContent=t,e[0].wrapper&&""!=t&&(e[0].wrapper.after(e[0].node),e[0].wrapper.remove());for(const t of e.slice(1,-1))i(t.node,!1),t.node.remove(),t.wrapper&&t.wrapper.remove();""==t&&i(e[0].node,!0),g.splice(N,1),N%=g.length,g[N]?.forEach((e=>e.wrapper.classList.add("editor-find-and-replace-current"))),g[N]&&g[N][0].wrapper?.scrollIntoView(!1)}}function x(e){for(const t of e.reverse())for(const e of t){const t=document.createTextNode(e.node.data.slice(e.endOffset,e.node.data.length));e.node.after(t);const n=document.createTextNode(e.node.data.slice(e.startOffset,e.endOffset));e.node.after(n),e.node.data=e.node.data.slice(0,e.startOffset),e.node=n,e.startOffset=0,e.endOffset=0}return e.reverse(),e}function w(e){for(const t of e)for(const e of t)e.wrapper=A(),e.node.after(e.wrapper),e.wrapper.append(e.node);return e}function R(e){for(const t of e)for(const e of t)e.wrapper&&(e.wrapper.after(e.node),e.wrapper.remove());return e}return l.addEventListener("click",(function(e){y=!y,l.classList.toggle("editor-toggled",y),f&&O()})),window.addEventListener("resize",(()=>{p&&v()})),r.addEventListener("click",O),a.addEventListener("click",(function(){g[N]?.forEach((e=>e.wrapper.classList.remove("editor-find-and-replace-current"))),-1==(N-=1)&&(N=g.length-1),g[N]?.forEach((e=>e.wrapper.classList.add("editor-find-and-replace-current"))),g[N]&&g[N][0].wrapper?.scrollIntoView(!1)})),d.addEventListener("click",(function(){g[N]?.forEach((e=>e.wrapper.classList.remove("editor-find-and-replace-current"))),N=(N+1)%g.length,g[N]?.forEach((e=>e.wrapper.classList.add("editor-find-and-replace-current"))),g[N]&&g[N][0].wrapper?.scrollIntoView(!1)})),u.addEventListener("click",(function(){k(h.value)})),m.addEventListener("click",(function(){for(;0!=g.length;)k(h.value)})),{open:function(){b?b=!1:(p=!0,i.style.display="block",n.menubarOptions.openFindAndReplace.setAttribute("aria-expanded","true"),i.setAttribute("aria-hidden","false"),i.setAttribute("aria-disabled","false"),s.value="",a.disabled=!0,d.disabled=!0,h.value="",u.disabled=!0,m.disabled=!0,document.addEventListener("mousedown",T),document.addEventListener("keydown",C),v())},close:E,find:L,highlight:w,unhighlight:R,prepareMatches:x}},e.exports=t}},t={};!function n(i){var o=t[i];if(void 0!==o)return o.exports;var s=t[i]={exports:{}};return e[i](s,s.exports,n),s.exports}(556)})();